import React, { useState, useRef, useCallback } from 'react';
import { Icons } from './Icons';
import { useDuckDBSync } from '../hooks/useDuckDBSync';
import { runGeminiPrompt } from '../services/geminiService';

// TABç±»å‹
type TabType = 'analysis' | 'workbench' | 'history';

// è¾“å…¥æ¨¡å¼
type InputMode = 'natural' | 'sql';


// SQL æŸ¥è¯¢å†å²ç±»å‹
interface SQLHistoryItem {
  id: string;
  inputType: InputMode;
  inputText: string;
  generatedSQL?: string;
  executedSQL: string;
  timestamp: number;
  executionTime?: number;
  resultCount?: number;
  success: boolean;
  error?: string;
}

// æ”¶è—çš„SQLç±»å‹
interface FavoriteSQL {
  id: string;
  name: string;
  sqlText: string;
  createdAt: number;
  tags?: string[];
}

// æŸ¥è¯¢ç»“æœç±»å‹
interface QueryResult {
  columns: string[];
  rows: any[][];
  executionTime: number;
  rowCount: number;
}

// æ”¶è—çš„SQLç±»å‹
interface FavoriteSQL {
  id: string;
  name: string;
  sqlText: string;
  createdAt: number;
  tags?: string[];
}

interface SQLConsoleProps {
  className?: string;
  onClose?: () => void;
}

export const SQLConsole: React.FC<SQLConsoleProps> = ({
  className = '',
  onClose
}) => {
  const { executeSQL, isInitialized, syncState } = useDuckDBSync();

  // TABçŠ¶ï¿½?
  const [activeTab, setActiveTab] = useState<TabType>('workbench');

  // å†å²&æ”¶è—å­TABçŠ¶ï¿½?
  const [historySubTab, setHistorySubTab] = useState<'history' | 'favorites'>('history');

  // SQLå·¥ä½œå°çŠ¶ï¿½?
  const [query, setQuery] = useState('');
  const [inputMode] = useState<InputMode>('sql');
  const [isExecuting, setIsExecuting] = useState(false);
  const [result, setResult] = useState<QueryResult | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [history, setHistory] = useState<SQLHistoryItem[]>([]);

  // æ”¶è—çŠ¶ï¿½?
  const [favorites, setFavorites] = useState<FavoriteSQL[]>([]);
  const [editingFavorite, setEditingFavorite] = useState<string | null>(null);
  const [editingName, setEditingName] = useState('');

  // æ•°æ®åˆ†æçŠ¶ï¿½?
  const [uploadedFile, setUploadedFile] = useState<File | null>(null);
  const [fileContent, setFileContent] = useState<string>('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState<string>('');

  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // æ‰§è¡ŒæŸ¥è¯¢
  const executeQuery = useCallback(async () => {
    if (!query.trim() || isExecuting) return;

    setIsExecuting(true);
    setError(null);
    setResult(null);

    try {
      const startTime = Date.now();
      const sqlResult = await executeSQL(query.trim());
      const executionTime = Date.now() - startTime;

      const processedResult: QueryResult = {
        columns: sqlResult.length > 0 ? Object.keys(sqlResult[0]) : [],
        rows: sqlResult.map(row => Object.values(row)),
        executionTime,
        rowCount: sqlResult.length
      };

      setResult(processedResult);

      // æ·»åŠ åˆ°å†å²è®°ï¿½?
      const historyItem: SQLHistoryItem = {
        id: `query_${Date.now()}`,
        inputType: inputMode,
        inputText: query.trim(),
        executedSQL: query.trim(),
        timestamp: Date.now(),
        executionTime,
        resultCount: sqlResult.length,
        success: true
      };

      setHistory(prev => [historyItem, ...prev.slice(0, 49)]);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'æ‰§è¡Œå¤±è´¥');
    } finally {
      setIsExecuting(false);
    }
  }, [query, inputMode, isExecuting, executeSQL]);

  // æ¸…ç©ºç»“æœ
  const clearResult = useCallback(() => {
    setResult(null);
    setError(null);
  }, []);

  // æ·»åŠ åˆ°æ”¶ï¿½?
  const addToFavorites = useCallback((sql: string, name?: string) => {
    const favorite: FavoriteSQL = {
      id: `fav_${Date.now()}`,
      name: name || `æ”¶è—æŸ¥è¯¢ ${favorites.length + 1}`,
      sqlText: sql,
      createdAt: Date.now(),
      tags: []
    };
    setFavorites(prev => [favorite, ...prev]);
  }, [favorites.length]);

  // ä»æ”¶è—ä¸­åˆ é™¤
  const removeFromFavorites = useCallback((id: string) => {
    setFavorites(prev => prev.filter(fav => fav.id !== id));
  }, []);

  // é‡å‘½åæ”¶ï¿½?
  const renameFavorite = useCallback((id: string, newName: string) => {
    setFavorites(prev => prev.map(fav =>
      fav.id === id ? { ...fav, name: newName } : fav
    ));
    setEditingFavorite(null);
    setEditingName('');
  }, []);

  // åŠ è½½æ”¶è—åˆ°æŸ¥è¯¢æ¡†
  const loadFavorite = useCallback((favorite: FavoriteSQL) => {
    setQuery(favorite.sqlText);
    setActiveTab('workbench'); // åˆ‡æ¢åˆ°å·¥ä½œå°TAB
  }, []);

  // ä»å†å²è®°å½•æ·»åŠ æ”¶ï¿½?
  const favoriteFromHistory = useCallback((historyItem: SQLHistoryItem) => {
    addToFavorites(historyItem.executedSQL, `æ¥è‡ªå†å²: ${historyItem.executedSQL.substring(0, 30)}...`);
  }, [addToFavorites]);

  // æ·»åŠ åˆ°æ”¶ï¿½?
  const addToFavorites = useCallback((item: SQLHistoryItem) => {
    const newFavorite: FavoriteSQL = {
      id: `fav_${Date.now()}`,
      name: item.executedSQL.length > 30
        ? `${item.executedSQL.substring(0, 30)}...`
        : item.executedSQL,
      sqlText: item.executedSQL,
      createdAt: Date.now(),
      tags: item.inputType === 'natural' && item.generatedSQL ? ['AIç”Ÿæˆ'] : []
    };
    setFavorites(prev => [newFavorite, ...prev]);
  }, []);

  // ä»æ”¶è—ä¸­ç§»é™¤
  const removeFromFavorites = useCallback((id: string) => {
    setFavorites(prev => prev.filter(fav => fav.id !== id));
  }, []);

  // æ›´æ–°æ”¶è—åç§°
  const updateFavoriteName = useCallback((id: string, newName: string) => {
    setFavorites(prev =>
      prev.map(fav =>
        fav.id === id ? { ...fav, name: newName } : fav
      )
    );
    setEditingFavorite(null);
    setEditingName('');
  }, []);

  // ä»å†å²åŠ è½½åˆ°SQLå·¥ä½œï¿½?
  const loadFromHistory = useCallback((item: SQLHistoryItem) => {
    setQuery(item.executedSQL);
    setActiveTab('workbench');
    textareaRef.current?.focus();
  }, []);

  // ä»æ”¶è—åŠ è½½åˆ°SQLå·¥ä½œï¿½?
  const loadFromFavorites = useCallback((favorite: FavoriteSQL) => {
    setQuery(favorite.sqlText);
    setActiveTab('workbench');
    textareaRef.current?.focus();
  }, []);

  // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
  const handleFileUpload = useCallback((event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // æ£€æŸ¥æ–‡ä»¶ç±»ï¿½?
    const allowedTypes = [
      'text/csv',
      'application/vnd.ms-excel',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'application/json',
      'text/markdown',
      'text/plain'
    ];

    if (!allowedTypes.some(type => file.type === type || file.name.toLowerCase().endsWith(type.split('/')[1] || ''))) {
      setError('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ã€‚è¯·ä¸Šä¼  CSVã€Excelã€JSON ï¿½?Markdown æ–‡ä»¶ï¿½?);
      return;
    }

    setUploadedFile(file);
    setError(null);

    // è¯»å–æ–‡ä»¶å†…å®¹
    const reader = new FileReader();
    reader.onload = (e) => {
      const content = e.target?.result as string;
      setFileContent(content);
    };
    reader.readAsText(file);
  }, []);

  // å¼€å§‹æ•°æ®åˆ†ï¿½?
  const startDataAnalysis = useCallback(async () => {
    if (!uploadedFile || !fileContent) {
      setError('è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶');
      return;
    }

    setIsAnalyzing(true);
    setError(null);
    setAnalysisResult('');

    try {
      // æ„å»ºAIæç¤ºï¿½?
      const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®åˆ†æå¸ˆï¼Œè¯·åˆ†æä»¥ä¸‹æ•°æ®æ–‡ä»¶å¹¶ç”Ÿæˆæœ‰ä»·å€¼çš„SQLæŸ¥è¯¢ï¿½?

æ–‡ä»¶ä¿¡æ¯ï¿½?
- æ–‡ä»¶ï¿½? ${uploadedFile.name}
- æ–‡ä»¶ç±»å‹: ${uploadedFile.type || 'æœªçŸ¥'}
- æ–‡ä»¶å¤§å°: ${(uploadedFile.size / 1024).toFixed(2)} KB

æ•°æ®å†…å®¹ï¼ˆå‰1000ä¸ªå­—ç¬¦ï¼‰ï¿½?
${fileContent.substring(0, 1000)}${fileContent.length > 1000 ? '\n\n[æ•°æ®å·²æˆªæ–­ï¼Œå®é™…æ–‡ä»¶æ›´å¤§]' : ''}

è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç”Ÿæˆåˆ†ææŠ¥å‘Šï¼š

ï¿½?. æ•°æ®æ¦‚è§ˆï¿½?
è§£è¯»ï¼šå¯¹æ•°æ®é›†çš„åŸºæœ¬æƒ…å†µè¿›è¡Œæè¿°ï¼ŒåŒ…æ‹¬è¡Œæ•°ã€åˆ—æ•°ã€æ•°æ®ç±»å‹ç­‰ï¿½?
è¯´æ˜ï¼šç”¨äºæŸ¥çœ‹æ•°æ®åŸºæœ¬ä¿¡æ¯çš„SQL
<SELECT COUNT(*) as total_rows FROM data_table;>

ï¿½?. æ•°æ®è´¨é‡æ£€æŸ¥ï¿½?
è§£è¯»ï¼šæ£€æŸ¥æ•°æ®è´¨é‡ï¼ŒåŒ…æ‹¬ç©ºå€¼ã€é‡å¤å€¼ã€å¼‚å¸¸å€¼ç­‰ï¿½?
è¯´æ˜ï¼šæ£€æŸ¥æ•°æ®è´¨é‡çš„SQL
<SELECT column_name, COUNT(*) as null_count FROM data_table WHERE column_name IS NULL GROUP BY column_name;>

ï¿½?. å…³é”®æŒ‡æ ‡åˆ†æï¿½?
è§£è¯»ï¼šåˆ†ææ•°æ®ä¸­çš„å…³é”®æŒ‡æ ‡å’Œè¶‹åŠ¿ï¿½?
è¯´æ˜ï¼šè®¡ç®—å…³é”®æŒ‡æ ‡çš„SQL
<SELECT metric, AVG(value) as average, MIN(value) as min_value, MAX(value) as max_value FROM data_table GROUP BY metric;>

ï¿½?. æ¨¡å¼è¯†åˆ«ï¿½?
è§£è¯»ï¼šè¯†åˆ«æ•°æ®ä¸­çš„æ¨¡å¼ã€å…³è”æˆ–å¼‚å¸¸ï¿½?
è¯´æ˜ï¼šè¯†åˆ«æ¨¡å¼çš„SQL
<SELECT pattern_column, COUNT(*) as frequency FROM data_table GROUP BY pattern_column ORDER BY frequency DESC LIMIT 10;>

è¯·ç¡®ä¿ï¼š
1. æ¯ä¸ªåˆ†æç‚¹éƒ½æœ‰æ˜ç¡®çš„è§£è¯»å’Œä¸šåŠ¡ä»·ï¿½?
2. SQLæŸ¥è¯¢åŸºäºå¸¸è§çš„æ•°æ®åº“è¡¨ç»“æ„ï¼ˆå‡è®¾æ•°æ®å·²å¯¼å…¥åˆ°åä¸ºdata_tableçš„è¡¨ä¸­ï¼‰
3. æŸ¥è¯¢ç»“æœåº”è¯¥æœ‰åŠ©äºç†è§£æ•°æ®ç‰¹ï¿½?
4. åˆ†æè¦å®¢è§‚ã€å‡†ç¡®ã€æœ‰æ´å¯ŸåŠ›`;

      // è°ƒç”¨AIåˆ†æ
      const result = await runGeminiPrompt(prompt);
      setAnalysisResult(result);

    } catch (err) {
      setError(err instanceof Error ? err.message : 'åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setIsAnalyzing(false);
    }
  }, [uploadedFile, fileContent]);

  // æ‰§è¡Œåˆ†æç»“æœä¸­çš„SQL
  const executeAnalysisSQL = useCallback((sql: string) => {
    setQuery(sql);
    setActiveTab('workbench');
    textareaRef.current?.focus();
  }, []);

  // æ¸…é™¤ä¸Šä¼ çš„æ–‡ï¿½?
  const clearUploadedFile = useCallback(() => {
    setUploadedFile(null);
    setFileContent('');
    setAnalysisResult('');
    setError(null);
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  }, []);

  // æ ¼å¼åŒ–æ—¶ï¿½?
  const formatExecutionTime = useCallback((ms: number) => {
    if (ms < 1000) return `${ms}ms`;
    return `${(ms / 1000).toFixed(2)}s`;
  }, []);

  // æ ¼å¼åŒ–æ—¶é—´æˆ³
  const formatTimestamp = useCallback((timestamp: number) => {
    return new Date(timestamp).toLocaleString();
  }, []);

  // é”®ç›˜äº‹ä»¶å¤„ç†
  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      executeQuery();
    }
  }, [executeQuery]);

  // Early return for initialization
  if (!isInitialized) {
    return (
      <div className={`bg-gray-900/98 border border-white/10 rounded-3xl shadow-2xl overflow-hidden ${className}`}>
        <div className="flex items-center justify-center h-64">
          <div className="text-center">
            <Icons.Database size={48} className="text-gray-600 mx-auto mb-4" />
            <div className="text-gray-400">æ­£åœ¨åˆå§‹ï¿½?DuckDB...</div>
            {syncState.error && (
              <div className="text-red-400 text-sm mt-2">{syncState.error}</div>
            )}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className={`bg-gray-900/98 border border-white/10 rounded-3xl shadow-2xl overflow-hidden ${className}`}>
      {/* Header */}
      <div className="relative bg-gradient-to-br from-brand-500/10 via-purple-500/5 to-blue-500/10 border-b border-white/10">
        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent animate-shimmer"></div>
        <div className="relative flex items-center justify-between p-6">
          <div className="flex items-center gap-4">
            <div className="w-10 h-10 bg-gradient-to-br from-brand-500/20 to-purple-500/20 rounded-xl flex items-center justify-center border border-brand-500/30">
              <Icons.Database size={20} className="text-brand-400" />
            </div>
            <div>
              <h1 className="text-xl font-bold text-white">DuckDB æ•°æ®æ§åˆ¶ï¿½?/h1>
              <p className="text-sm text-gray-400">æ•°æ®åˆ†æ ï¿½?SQL å·¥ä½œï¿½?ï¿½?æ‰§è¡Œå†å²</p>
            </div>
          </div>
          {onClose && (
            <button
              onClick={onClose}
              className="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 transform hover:scale-105"
            >
              <Icons.Close size={20} />
            </button>
          )}
        </div>
      </div>

      {/* TAB Navigation */}
      <div className="bg-gray-900/60 border-b border-white/5">
        <div className="flex">
          {[
            { id: 'analysis' as TabType, label: 'æ•°æ®åˆ†æ', icon: Icons.Analysis },
            { id: 'workbench' as TabType, label: 'SQL å·¥ä½œï¿½?, icon: Icons.Code },
            { id: 'history' as TabType, label: 'å†å² & æ”¶è—', icon: Icons.History }
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 flex items-center justify-center gap-2 py-4 px-4 text-sm font-medium transition-all duration-200 ${
                activeTab === tab.id
                  ? 'text-white bg-brand-500/20 border-b-2 border-brand-500'
                  : 'text-gray-400 hover:text-white hover:bg-white/5'
              }`}
            >
              <tab.icon size={16} />
              {tab.label}
            </button>
          ))}
        </div>
      </div>

      {/* Content Area */}
      <div className="flex-1 min-h-0">
        {activeTab === 'workbench' && (
          <div className="h-full flex flex-col">
            {/* SQL Editor */}
            <div className="p-4 border-b border-white/5">
              <div className="space-y-3">
                <textarea
                  ref={textareaRef}
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder={inputMode === 'natural'
                    ? "æè¿°ä½ æƒ³è¦æŸ¥è¯¢çš„å†…å®¹..."
                    : "è¾“å…¥ DuckDB SQL æŸ¥è¯¢..."
                  }
                  className="w-full h-32 bg-gray-800 border border-white/10 rounded-lg p-3 text-gray-200 font-mono text-sm resize-none focus:outline-none focus:border-brand-500/50"
                  disabled={isExecuting}
                />

                {/* Action Buttons */}
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <button
                      onClick={clearResult}
                      className="flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white text-sm rounded transition-colors"
                    >
                      <Icons.Trash size={14} />
                      æ¸…ç©º
                    </button>
                  </div>

                  <div className="text-xs text-gray-500">
                    Ctrl+Enter æ‰§è¡ŒæŸ¥è¯¢
                  </div>
                </div>
              </div>
            </div>

            {/* Results Area */}
            <div className="flex-1 overflow-hidden">
              {error && (
                <div className="p-4 bg-red-900/20 border-l-4 border-red-500">
                  <div className="flex items-center gap-2 mb-2">
                    <Icons.Error size={16} className="text-red-400" />
                    <span className="text-red-400 font-semibold">æ‰§è¡Œå¤±è´¥</span>
                  </div>
                  <div className="text-red-300 text-sm font-mono bg-red-900/10 p-3 rounded border border-red-500/20">
                    {error}
                  </div>
                </div>
              )}

              {result && (
                <div className="h-full flex flex-col">
                  {/* Results Header */}
                  <div className="flex items-center justify-between p-3 bg-gray-800/50 border-b border-white/5">
                    <div className="flex items-center gap-4 text-sm">
                      <span className="text-green-400 flex items-center gap-1">
                        <Icons.Check size={14} />
                        æ‰§è¡ŒæˆåŠŸ
                      </span>
                      {result.columns.length > 0 ? (
                        <>
                          <span className="text-gray-400">
                            {result.rowCount} ï¿½?Ã— {result.columns.length} ï¿½?
                          </span>
                          <span className="text-gray-400">
                            æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                          </span>
                        </>
                      ) : (
                        <span className="text-gray-400">
                          æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                        </span>
                      )}
                    </div>
                    <div className="flex items-center gap-2">
                      {result.columns.length > 0 && (
                        <button
                          onClick={() => navigator.clipboard.writeText(JSON.stringify(result.rows, null, 2))}
                          className="text-gray-400 hover:text-white text-sm flex items-center gap-1"
                        >
                          <Icons.Copy size={14} />
                          å¤åˆ¶ç»“æœ
                        </button>
                      )}
                    </div>
                  </div>

                  {/* Results Table */}
                  <div className="flex-1 overflow-auto">
                    {result.columns.length === 0 ? (
                      <div className="p-8 text-center">
                        <div className="text-green-400 mb-2">
                          <Icons.Check size={24} className="mx-auto" />
                        </div>
                        <div className="text-gray-300 font-medium mb-1">
                          {result.rowCount === 0 ? 'æŸ¥è¯¢æˆåŠŸï¼Œè¿”ï¿½?0 æ¡è®°ï¿½? : `æ‰§è¡ŒæˆåŠŸï¼Œå½±ï¿½?${result.rowCount} è¡Œ`}
                        </div>
                        <div className="text-gray-500 text-sm">
                          æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                        </div>
                      </div>
                    ) : (
                      <table className="w-full text-sm">
                        <thead className="bg-gray-800/30 sticky top-0">
                          <tr>
                            {result.columns.map((column, index) => (
                              <th
                                key={index}
                                className="px-3 py-2 text-left text-gray-300 font-semibold border-r border-white/5 last:border-r-0"
                              >
                                {column}
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {result.rows.map((row, rowIndex) => (
                            <tr key={rowIndex} className="border-b border-white/5 hover:bg-white/5">
                              {row.map((cell: any, cellIndex: number) => (
                                <td
                                  key={cellIndex}
                                  className="px-3 py-2 text-gray-200 border-r border-white/5 last:border-r-0 max-w-xs"
                                >
                                  {cell === null || cell === undefined ? (
                                    <span className="text-gray-500 italic">NULL</span>
                                  ) : typeof cell === 'boolean' ? (
                                    <span className={cell ? 'text-green-400' : 'text-red-400'}>
                                      {cell ? 'TRUE' : 'FALSE'}
                                    </span>
                                  ) : (
                                    <span className={typeof cell === 'number' ? 'text-blue-300' : ''}>
                                      {String(cell)}
                                    </span>
                                  )}
                                </td>
                              ))}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>
                </div>
              )}

              {!result && !error && (
                <div className="p-8 text-center text-gray-500 h-full flex items-center justify-center">
                  <div>
                    <Icons.Database size={48} className="text-gray-600 mx-auto mb-4" />
                    <div>è¾“å…¥ SQL æŸ¥è¯¢å¹¶ç‚¹å‡»æ‰§è¡Œï¼Œæˆ–é€‰æ‹©ä¸€ä¸ªæŸ¥è¯¢æ¨¡ï¿½?/div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {activeTab === 'analysis' && (
          <div className="h-full flex flex-col p-6">
            <div className="text-center py-12">
              <Icons.Analysis size={48} className="text-gray-600 mx-auto mb-4" />
              <div className="text-gray-400">æ•°æ®åˆ†æåŠŸèƒ½å¼€å‘ä¸­...</div>
              <div className="text-sm text-gray-500 mt-2">å³å°†æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’ŒAIé©±åŠ¨çš„æ•°æ®åˆ†ï¿½?/div>
            </div>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="h-full flex flex-col">
            {/* Sub-tabs */}
            <div className="flex border-b border-white/5 bg-gray-900/40">
              <button
                onClick={() => setHistorySubTab('history')}
                className={`flex-1 py-3 px-4 text-sm font-medium transition-all duration-200 ${
                  historySubTab === 'history'
                    ? 'text-white bg-brand-500/20 border-b-2 border-brand-500'
                    : 'text-gray-400 hover:text-white hover:bg-white/5'
                }`}
              >
                ğŸ• å†å²è®°å½• ({history.length})
              </button>
              <button
                onClick={() => setHistorySubTab('favorites')}
                className={`flex-1 py-3 px-4 text-sm font-medium transition-all duration-200 ${
                  historySubTab === 'favorites'
                    ? 'text-white bg-brand-500/20 border-b-2 border-brand-500'
                    : 'text-gray-400 hover:text-white hover:bg-white/5'
                }`}
              >
                ï¿½?æˆ‘çš„æ”¶è— ({favorites.length})
              </button>
            </div>

            {/* Content Area */}
            <div className="flex-1 overflow-hidden">
              {historySubTab === 'history' ? (
                /* History Table */
                <div className="h-full overflow-y-auto">
                  {history.length === 0 ? (
                    <div className="p-8 text-center text-gray-500">
                      <Icons.History size={48} className="text-gray-600 mx-auto mb-4" />
                      <div className="text-lg font-medium mb-2">æš‚æ— æ‰§è¡Œå†å²</div>
                      <div className="text-sm">æ‰§è¡Œ SQL æŸ¥è¯¢åï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-gray-800/30 sticky top-0">
                          <tr className="text-left">
                            <th className="px-4 py-3 text-gray-300 font-semibold">æ—¶é—´</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">ç±»å‹</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">SQL æ‘˜è¦</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">çŠ¶ï¿½?/th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-white/5">
                          {history.map((item) => (
                            <tr key={item.id} className="hover:bg-white/5 transition-colors">
                              <td className="px-4 py-3 text-gray-400 text-xs">
                                <div>{new Date(item.timestamp).toLocaleDateString()}</div>
                                <div className="text-gray-500">{new Date(item.timestamp).toLocaleTimeString()}</div>
                              </td>
                              <td className="px-4 py-3">
                                <span className={`px-2 py-1 rounded text-xs font-medium ${
                                  item.inputType === 'natural'
                                    ? 'bg-purple-500/20 text-purple-400'
                                    : 'bg-blue-500/20 text-blue-400'
                                }`}>
                                  {item.inputType === 'natural' ? 'è‡ªç„¶è¯­è¨€' : 'æ‰‹åŠ¨'}
                                </span>
                              </td>
                              <td className="px-4 py-3 max-w-xs">
                                <div className="text-gray-200 text-sm truncate" title={item.executedSQL}>
                                  {item.executedSQL.length > 50
                                    ? `${item.executedSQL.substring(0, 50)}...`
                                    : item.executedSQL
                                  }
                                </div>
                                {item.resultCount !== undefined && (
                                  <div className="text-xs text-gray-500 mt-1">
                                    è¿”å› {item.resultCount} ï¿½?
                                  </div>
                                )}
                              </td>
                              <td className="px-4 py-3">
                                <div className="flex items-center gap-2">
                                  {item.success ? (
                                    <>
                                      <Icons.Check size={14} className="text-green-400" />
                                      <span className="text-green-400 text-xs">æˆåŠŸ</span>
                                    </>
                                  ) : (
                                    <>
                                      <Icons.Error size={14} className="text-red-400" />
                                      <span className="text-red-400 text-xs">å¤±è´¥</span>
                                    </>
                                  )}
                                </div>
                                {item.executionTime && (
                                  <div className="text-xs text-gray-500 mt-1">
                                    {formatExecutionTime(item.executionTime)}
                                  </div>
                                )}
                              </td>
                              <td className="px-4 py-3">
                                <div className="flex items-center gap-1">
                                  <button
                                    onClick={() => {
                                      setQuery(item.executedSQL);
                                      setActiveTab('workbench');
                                    }}
                                    className="text-gray-400 hover:text-white text-xs px-2 py-1 rounded transition-colors"
                                    title="è·³è½¬ï¿½?SQL å·¥ä½œï¿½?
                                  >
                                    â†—ï¸
                                  </button>
                                  <button
                                    onClick={() => favoriteFromHistory(item)}
                                    className="text-gray-400 hover:text-yellow-400 text-xs px-2 py-1 rounded transition-colors"
                                    title="åŠ å…¥æ”¶è—"
                                  >
                                    ï¿½?
                                  </button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              ) : (
                /* Favorites List */
                <div className="h-full overflow-y-auto">
                  <div className="divide-y divide-white/5">
                    {favorites.length === 0 ? (
                      <div className="p-8 text-center text-gray-500">
                        <Icons.Star size={48} className="text-gray-600 mx-auto mb-4" />
                        <div className="text-lg font-medium mb-2">æš‚æ— æ”¶è—</div>
                        <div className="text-sm">ä»å†å²è®°å½•ä¸­æ”¶è—æœ‰ç”¨çš„ SQL æŸ¥è¯¢</div>
                      </div>
                    ) : (
                      favorites.map((favorite) => (
                        <div key={favorite.id} className="p-4 hover:bg-white/5 transition-colors group">
                          <div className="flex items-start justify-between mb-3">
                            <div className="flex-1">
                              {editingFavorite === favorite.id ? (
                                <div className="flex items-center gap-2">
                                  <input
                                    value={editingName}
                                    onChange={(e) => setEditingName(e.target.value)}
                                    onKeyDown={(e) => {
                                      if (e.key === 'Enter') {
                                        renameFavorite(favorite.id, editingName);
                                      } else if (e.key === 'Escape') {
                                        setEditingFavorite(null);
                                        setEditingName('');
                                      }
                                    }}
                                    className="flex-1 px-2 py-1 text-sm bg-gray-800 border border-brand-500/50 rounded focus:outline-none focus:border-brand-500"
                                    autoFocus
                                  />
                                  <button
                                    onClick={() => renameFavorite(favorite.id, editingName)}
                                    className="p-1 text-green-400 hover:text-green-300"
                                  >
                                    <Icons.Check size={14} />
                                  </button>
                                  <button
                                    onClick={() => {
                                      setEditingFavorite(null);
                                      setEditingName('');
                                    }}
                                    className="p-1 text-gray-400 hover:text-gray-300"
                                  >
                                    <Icons.Close size={14} />
                                  </button>
                                </div>
                              ) : (
                                <div
                                  className="text-sm font-medium text-gray-200 cursor-pointer hover:text-white"
                                  onClick={() => {
                                    setEditingFavorite(favorite.id);
                                    setEditingName(favorite.name);
                                  }}
                                >
                                  {favorite.name}
                                </div>
                              )}
                            </div>
                            <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                              <button
                                onClick={() => loadFavorite(favorite)}
                                className="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded transition-colors"
                                title="åœ¨SQLå·¥ä½œå°ä¸­æ‰“å¼€"
                              >
                                <Icons.Edit size={14} />
                              </button>
                              <button
                                onClick={() => removeFromFavorites(favorite.id)}
                                className="p-2 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors"
                                title="ä»æ”¶è—ä¸­ç§»é™¤"
                              >
                                <Icons.Trash size={14} />
                              </button>
                            </div>
                          </div>

                          <div className="mb-2">
                            <div className="text-sm text-gray-300 font-mono bg-gray-800/50 p-3 rounded border border-white/5 leading-relaxed">
                              {favorite.sqlText.length > 200
                                ? `${favorite.sqlText.substring(0, 200)}...`
                                : favorite.sqlText
                              }
                            </div>
                          </div>

                          <div className="text-xs text-gray-500">
                            åˆ›å»ºæ—¶é—´: {formatTimestamp(favorite.createdAt)}
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
