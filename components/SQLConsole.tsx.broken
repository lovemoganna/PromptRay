import React, { useState, useRef, useCallback } from 'react';
import { Icons } from './Icons';
import { useDuckDBSync } from '../hooks/useDuckDBSync';
import { runGeminiPrompt } from '../services/geminiService';

// TABç±»å‹
type TabType = 'analysis' | 'workbench' | 'history';

// è¾“å…¥æ¨¡å¼
type InputMode = 'natural' | 'sql';

// NL2SQL è½¬æ¢ç»“æœ
interface NL2SQLResult {
  sql: string;
  confidence?: number;
  explanation?: string;
}

// SQL æŸ¥è¯¢å†å²ç±»å‹
interface SQLHistoryItem {
  id: string;
  inputType: InputMode;
  inputText: string;
  generatedSQL?: string;
  executedSQL: string;
  timestamp: number;
  executionTime?: number;
  resultCount?: number;
  success: boolean;
  error?: string;
}

// æŸ¥è¯¢ç»“æœç±»å‹
interface QueryResult {
  columns: string[];
  rows: any[][];
  executionTime: number;
  rowCount: number;
}

// æ•°æ®åˆ†æä¼šè¯ç±»å‹
interface AnalysisSession {
  id: string;
  fileName: string;
  fileType: string;
  aiResponse: string;
  createdAt: number;
}

// æ”¶è—çš„SQLç±»å‹
interface FavoriteSQL {
  id: string;
  name: string;
  sqlText: string;
  createdAt: number;
}

interface SQLConsoleProps {
  className?: string;
  onClose?: () => void;
}

export const SQLConsole: React.FC<SQLConsoleProps> = ({
  className = '',
  onClose
}) => {
  const {
    executeSQL,
    isInitialized,
    syncState,
    initializeSQLTables,
    saveSQLHistory,
    saveSQLFavorite,
    deleteSQLFavorite,
    updateSQLFavoriteName,
    saveAnalysisSession,
    loadSQLHistory,
    loadSQLFavorites,
    loadAnalysisSessions
  } = useDuckDBSync();

  // TABçŠ¶?
  const [activeTab, setActiveTab] = useState<TabType>('workbench');

  // SQLå·¥ä½œå°çŠ¶?
  const [query, setQuery] = useState('');
  const [inputMode, setInputMode] = useState<InputMode>('sql');
  const [isExecuting, setIsExecuting] = useState(false);
  const [isConverting, setIsConverting] = useState(false);
  const [result, setResult] = useState<QueryResult | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [history, setHistory] = useState<SQLHistoryItem[]>([]);
  const [showTableStructure, setShowTableStructure] = useState(false);

  // NL2SQL ç›¸å…³çŠ¶?
  const [nl2sqlResult, setNl2sqlResult] = useState<NL2SQLResult | null>(null);
  const [showConversionPreview, setShowConversionPreview] = useState(false);

  // è¿ç»­å¯¹è¯çŠ¶?
  const [conversationContext, setConversationContext] = useState<{
    lastQuery: string;
    lastResult: any[] | null;
    conversationHistory: Array<{
      type: 'user' | 'system';
      message: string;
      timestamp: number;
    }>;
  } | null>(null);

  // æ•°æ®åˆ†æçŠ¶?
  const [analysisSessions, setAnalysisSessions] = useState<AnalysisSession[]>([]);

  // å†å²&æ”¶è—çŠ¶?
  const [favorites, setFavorites] = useState<FavoriteSQL[]>([]);

  // å¼•ç”¨
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  // åˆå§‹åŒ–å’Œæ•°æ®åŠ è½½
  useEffect(() => {
    if (isInitialized) {
      // åˆå§‹åŒ–SQLè¡¨
      initializeSQLTables();

      // åŠ è½½å†å²æ•°æ®
      const loadData = async () => {
        try {
          const historyData = await loadSQLHistory();
          const favoritesData = await loadSQLFavorites();
          const analysisData = await loadAnalysisSessions();

          // è½¬æ¢æ•°æ®æ ¼å¼
          const formattedHistory: SQLHistoryItem[] = historyData.map(item => ({
            id: item.id,
            inputType: item.inputType as InputMode,
            inputText: item.inputText,
            generatedSQL: item.generatedSQL,
            executedSQL: item.executedSQL,
            timestamp: item.timestamp,
            executionTime: item.executionTime,
            resultCount: item.resultCount,
            success: item.success === 1,
            error: item.error
          }));

          const formattedFavorites: FavoriteSQL[] = favoritesData.map(item => ({
            id: item.id,
            name: item.name,
            sqlText: item.sqlText,
            createdAt: item.createdAt,
            tags: item.tags ? JSON.parse(item.tags) : undefined
          }));

          setHistory(formattedHistory);
          setFavorites(formattedFavorites);
          setAnalysisSessions(analysisData);
        } catch (error) {
          console.error('Failed to load SQL console data:', error);
        }
      };

      loadData();
    }
  }, [isInitialized, initializeSQLTables, loadSQLHistory, loadSQLFavorites, loadAnalysisSessions]);
  const historyRef = useRef<HTMLDivElement>(null);

  // æ£€æµ‹å±é™©SQLæ“ä½œ
  const isDangerousOperation = useCallback((sql: string): boolean => {
    const sqlLower = sql.toLowerCase().trim();
    return sqlLower.includes('delete ') ||
           sqlLower.includes('drop ') ||
           sqlLower.includes('truncate ') ||
           sqlLower.includes('alter ');
  }, []);

  // NL2SQL è½¬æ¢
  const convertNaturalLanguageToSQL = useCallback(async (naturalLanguage: string): Promise<NL2SQLResult> => {
    let contextPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ SQL ç”ŸæˆåŠ©æ‰‹ï¼Œä¸“é—¨ä¸ºä¸€ä¸ªæç¤ºè¯ç®¡ç†ç³»ç»Ÿç”Ÿæˆ DuckDB SQL æŸ¥è¯¢?

æ•°æ®åº“ç»“æ„è¯´æ˜ï¼š
- prompts è¡¨ï¼šå­˜å‚¨æç¤ºè¯æ•°?
  - id: å­—ç¬¦ä¸²ï¼Œæç¤ºè¯å”¯ä¸€æ ‡è¯†
  - title: å­—ç¬¦ä¸²ï¼Œæç¤ºè¯æ ‡?
  - content: å­—ç¬¦ä¸²ï¼Œæç¤ºè¯å†…?
  - category: å­—ç¬¦ä¸²ï¼Œåˆ†ç±»ï¼ˆå¦‚ï¼šCode, Writing, Ideas, Analysis, Fun, Misc?
  - tags: JSONæ•°ç»„ï¼Œæ ‡ç­¾åˆ—?
  - isFavorite: å¸ƒå°”å€¼ï¼Œæ˜¯å¦æ”¶è—
  - createdAt: æ—¶é—´æˆ³ï¼Œåˆ›å»ºæ—¶é—´
  - updatedAt: æ—¶é—´æˆ³ï¼Œæ›´æ–°æ—¶é—´
  - deletedAt: æ—¶é—´æˆ³ï¼Œè½¯åˆ é™¤æ ‡è®°ï¼ˆNULLè¡¨ç¤ºæœªåˆ é™¤ï¼‰

å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼?
1. æŸ¥çœ‹æ‰€æœ‰æç¤ºè¯ï¼šSELECT * FROM prompts WHERE deletedAt IS NULL
2. æŒ‰åˆ†ç±»ç­›é€‰ï¼šSELECT * FROM prompts WHERE category = 'Code' AND deletedAt IS NULL
3. æœç´¢å†…å®¹ï¼šSELECT * FROM prompts WHERE content LIKE '%å…³é”®?' AND deletedAt IS NULL
4. æ”¶è—çš„æç¤ºè¯ï¼šSELECT * FROM prompts WHERE isFavorite = 1 AND deletedAt IS NULL
5. ç»Ÿè®¡åˆ†ç±»æ•°é‡ï¼šSELECT category, COUNT(*) as count FROM prompts WHERE deletedAt IS NULL GROUP BY category`;

    // æ·»åŠ å¯¹è¯ä¸Šä¸‹?
    if (conversationContext) {
      contextPrompt += `

å¯¹è¯ä¸Šä¸‹æ–‡ï¼š
- ä¸Šä¸€ä¸ªæŸ¥è¯¢: ${conversationContext.lastQuery}
- ä¸Šæ¬¡ç»“æœ: ${conversationContext.lastResult ?
  `è¿”å› ${conversationContext.lastResult.length} æ¡è®°å½•` :
  'æ— ç»“æœæˆ–æ‰§è¡Œäº†ä¿®æ”¹æ“ä½œ'}

å¯¹è¯å†å²:
${conversationContext.conversationHistory.slice(-3).map(h =>
`${h.type === 'user' ? 'ç”¨æˆ·' : 'ç³»ç»Ÿ'}: ${h.message}`
).join('\n')}

è¯·æ ¹æ®å¯¹è¯ä¸Šä¸‹æ–‡ç†è§£ç”¨æˆ·çš„æ„å›¾ï¼Œç”Ÿæˆåˆé€‚çš„ SQL æŸ¥è¯¢ã€‚
å¦‚æœ?å‰N??æ’åº"?ç­›?ç­‰æ“ä½œï¼Œè¯·åŸºäºä¸Šä¸€ä¸ªæŸ¥è¯¢è¿›è¡Œä¿®æ”¹ã€‚`;
    }

    contextPrompt += `

è¯·æ ¹æ®ç”¨æˆ·æè¿°ç”Ÿæˆç›¸åº”çš„ DuckDB SQL æŸ¥è¯¢ï¼Œç›´æ¥è¿”?SQL è¯­å¥ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šã€‚`;

    try {
      const response = await runGeminiPrompt(naturalLanguage, {
        systemInstruction: contextPrompt,
        model: 'gemini-2.5-flash',
        temperature: 0.1, // é™ä½éšæœºæ€§ï¼Œç¡®ä¿SQLå‡†ç¡®?
        maxOutputTokens: 500
      });

      // æ¸…ç†å“åº”ï¼Œæå–çº¯SQL
      const sql = response.trim()
        .replace(/^```sql\s*/i, '')
        .replace(/^```\s*/i, '')
        .replace(/\s*```$/i, '')
        .replace(/^SQL:\s*/i, '')
        .replace(/^\s*-\s*/, '')
        .trim();

      return {
        sql,
        confidence: 0.8, // æš‚æ—¶å›ºå®šç½®ä¿¡?
        explanation: conversationContext
          ? `åŸºäºå¯¹è¯ä¸Šä¸‹æ–‡ç”Ÿæˆçš„SQLæŸ¥è¯¢`
          : `åŸºäº"${naturalLanguage}"ç”Ÿæˆçš„SQLæŸ¥è¯¢`
      };
    } catch (error) {
      throw new Error(`NL2SQLè½¬æ¢å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);
    }
  }, [conversationContext]);

  // æ‰§è¡ŒSQLæŸ¥è¯¢
  const executeQuery = useCallback(async (sqlToExecute?: string) => {
    const finalSQL = sqlToExecute || query.trim();
    if (!finalSQL || isExecuting) return;

    // å±é™©æ“ä½œæ£€?
    if (isDangerousOperation(finalSQL)) {
      const confirmed = window.confirm(
        `âš ï¸ å±é™©æ“ä½œç¡®è®¤\n\næ­¤æ“ä½œåŒ…å«å±é™©çš„SQLè¯­å¥ï¼ˆå¦‚DELETEã€DROPã€TRUNCATEæˆ–ALTERï¼‰ï¼Œå¯èƒ½ä¼šä¿®æ”¹æˆ–åˆ é™¤æ•°æ®ã€‚\n\nSQL: ${finalSQL}\n\næ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Ÿ`
      );

      if (!confirmed) return;
    }

    const startTime = Date.now();
    setIsExecuting(true);
    setError(null);
    setResult(null);
    setShowConversionPreview(false);

    try {
      const sqlResult = await executeSQL(finalSQL);
      const executionTime = Date.now() - startTime;

      // å¤„ç†æŸ¥è¯¢ç»“æœ
      const processedResult: QueryResult = {
        columns: sqlResult.length > 0 ? Object.keys(sqlResult[0]) : [],
        rows: sqlResult.map(row => Object.values(row)),
        executionTime,
        rowCount: sqlResult.length
      };

      setResult(processedResult);

      // æ·»åŠ åˆ°å†å²è®°å½•
      const historyItem: SQLHistoryItem = {
        id: `query_${Date.now()}`,
        inputType: inputMode,
        inputText: query.trim(),
        generatedSQL: inputMode === 'natural' ? nl2sqlResult?.sql : undefined,
        executedSQL: finalSQL,
        timestamp: Date.now(),
        executionTime,
        resultCount: sqlResult.length,
        success: true
      };

      setHistory(prev => [historyItem, ...prev.slice(0, 49)]); // ä¿ç•™æœ€è¿‘50æ¡è®°å½•

      // ä¿å­˜åˆ°æ•°æ®åº“
      saveSQLHistory(historyItem);

      // æ›´æ–°å¯¹è¯ä¸Šä¸‹?
      setConversationContext({
        lastQuery: finalSQL,
        lastResult: sqlResult,
        conversationHistory: [
          ...(conversationContext?.conversationHistory || []),
          {
            type: 'user' as const,
            message: inputMode === 'natural' ? query.trim() : `æ‰§è¡ŒSQL: ${finalSQL}`,
            timestamp: Date.now()
          },
          {
            type: 'system' as const,
            message: `æŸ¥è¯¢æˆåŠŸï¼Œè¿”?${sqlResult.length} æ¡è®°å½•`,
            timestamp: Date.now()
          }
        ].slice(-10) // ä¿ç•™æœ€?0æ¡å¯¹?
      });

    } catch (err) {
      const executionTime = Date.now() - startTime;
      const errorMessage = err instanceof Error ? err.message : 'Unknown error';

      setError(errorMessage);

      // æ·»åŠ å¤±è´¥çš„æŸ¥è¯¢åˆ°å†å²è®°å½•
      const historyItem: SQLHistoryItem = {
        id: `query_${Date.now()}`,
        inputType: inputMode,
        inputText: query.trim(),
        generatedSQL: inputMode === 'natural' ? nl2sqlResult?.sql : undefined,
        executedSQL: finalSQL,
        timestamp: Date.now(),
        executionTime,
        success: false,
        error: errorMessage
      };

      setHistory(prev => [historyItem, ...prev.slice(0, 49)]);
    } finally {
      setIsExecuting(false);
    }
  }, [query, inputMode, nl2sqlResult, isExecuting, executeSQL, isDangerousOperation]);

  // å¤„ç†NL2SQLè½¬æ¢
  const handleNL2SQLConversion = useCallback(async () => {
    if (!query.trim() || isConverting || inputMode !== 'natural') return;

    setIsConverting(true);
    setError(null);

    try {
      const result = await convertNaturalLanguageToSQL(query.trim());
      setNl2sqlResult(result);
      setShowConversionPreview(true);
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'NL2SQLè½¬æ¢å¤±è´¥';
      setError(errorMessage);
    } finally {
      setIsConverting(false);
    }
  }, [query, inputMode, isConverting, convertNaturalLanguageToSQL]);

  // ç¡®è®¤æ‰§è¡Œè½¬æ¢åçš„SQL
  const confirmExecuteConvertedSQL = useCallback(() => {
    if (nl2sqlResult) {
      executeQuery(nl2sqlResult.sql);
    }
  }, [nl2sqlResult, executeQuery]);

  // ç¼–è¾‘è½¬æ¢åçš„SQL
  const editConvertedSQL = useCallback(() => {
    if (nl2sqlResult) {
      setQuery(nl2sqlResult.sql);
      setInputMode('sql');
      setShowConversionPreview(false);
      setNl2sqlResult(null);
    }
  }, [nl2sqlResult]);

  // æ¸…ç©ºç»“æœ
  const clearResult = useCallback(() => {
    setResult(null);
    setError(null);
    setNl2sqlResult(null);
    setShowConversionPreview(false);
    // æ³¨æ„ï¼šä¸æ¸…ç©ºå¯¹è¯ä¸Šä¸‹æ–‡ï¼Œè®©ç”¨æˆ·å¯ä»¥ç»§ç»­è¿½?
  }, []);

  // ä»å†å²è®°å½•åŠ è½½æŸ¥?
  const loadFromHistory = useCallback((historyItem: SQLHistoryItem) => {
    setQuery(historyItem.inputText);
    setInputMode(historyItem.inputType);
    if (historyItem.generatedSQL) {
      setNl2sqlResult({ sql: historyItem.generatedSQL, explanation: 'ä»å†å²è®°å½•åŠ è½½' });
    } else {
      setNl2sqlResult(null);
    }
    setSelectedHistoryIndex(-1);
    setShowHistory(false);
    setShowConversionPreview(false);
    textareaRef.current?.focus();
  }, []);

  // æ¸…ç©ºå†å²è®°å½•
  const clearHistory = useCallback(() => {
    setHistory([]);
  }, []);

  // æ·»åŠ åˆ°æ”¶è—
  const addToFavorites = useCallback((sql: string, name?: string) => {
    const favorite: FavoriteSQL = {
      id: `fav_${Date.now()}`,
      name: name || `æ”¶è—æŸ¥è¯¢ ${favorites.length + 1}`,
      sqlText: sql,
      createdAt: Date.now(),
      tags: []
    };
    setFavorites(prev => [favorite, ...prev]);

    // ä¿å­˜åˆ°æ•°æ®åº“
    saveSQLFavorite(favorite);
  }, [favorites.length, saveSQLFavorite]);

  // ä»æ”¶è—ä¸­åˆ é™¤
  const removeFromFavorites = useCallback((id: string) => {
    setFavorites(prev => prev.filter(fav => fav.id !== id));

    // ä»æ•°æ®åº“åˆ é™¤
    deleteSQLFavorite(id);
  }, [deleteSQLFavorite]);

  // é‡å‘½åæ”¶è—
  const renameFavorite = useCallback((id: string, newName: string) => {
    setFavorites(prev => prev.map(fav =>
      fav.id === id ? { ...fav, name: newName } : fav
    ));

    // æ›´æ–°æ•°æ®åº“
    updateSQLFavoriteName(id, newName);
  }, [updateSQLFavoriteName]);

  // åŠ è½½æ”¶è—åˆ°æŸ¥è¯¢æ¡†
  const loadFavorite = useCallback((favorite: FavoriteSQL) => {
    setQuery(favorite.sqlText);
    setActiveTab('workbench'); // åˆ‡æ¢åˆ°å·¥ä½œå°TAB
  }, []);

  // ä»å†å²è®°å½•æ·»åŠ æ”¶è—
  const favoriteFromHistory = useCallback((historyItem: SQLHistoryItem) => {
    addToFavorites(historyItem.executedSQL, `æ¥è‡ªå†å²: ${historyItem.executedSQL.substring(0, 30)}...`);
  }, [addToFavorites]);

  // å¿«æ·é”®å¤„ç†
  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      if (inputMode === 'natural') {
        handleNL2SQLConversion();
      } else {
        executeQuery();
      }
    } else if (e.key === 'ArrowUp' && !showHistory && history.length > 0) {
      e.preventDefault();
      setSelectedHistoryIndex(0);
      setShowHistory(true);
    }
  }, [executeQuery, handleNL2SQLConversion, inputMode, showHistory, history.length]);

  // å¸¸ç”¨æŸ¥è¯¢æ¨¡æ¿
  const queryTemplates = [
    {
      name: 'æŸ¥çœ‹æ‰€æœ‰æç¤ºè¯',
      query: 'SELECT id, title, category, isFavorite, createdAt FROM prompts WHERE deletedAt IS NULL ORDER BY createdAt DESC LIMIT 10;'
    },
    {
      name: 'ç»Ÿè®¡å„åˆ†ç±»æ•°é‡',
      query: 'SELECT category, COUNT(*) as count FROM prompts WHERE deletedAt IS NULL GROUP BY category ORDER BY count DESC;'
    },
    {
      name: 'æŸ¥æ‰¾æ”¶è—çš„æç¤ºè¯',
      query: 'SELECT title, category, tags FROM prompts WHERE isFavorite = 1 AND deletedAt IS NULL;'
    },
    {
      name: 'æœ€è¿‘åˆ›å»ºçš„æç¤ºè¯',
      query: 'SELECT title, category, createdAt FROM prompts WHERE deletedAt IS NULL ORDER BY createdAt DESC LIMIT 5;'
    },
    {
      name: 'æœç´¢åŒ…å«å…³é”®è¯çš„æç¤ºè¯',
      query: 'SELECT title, content FROM prompts WHERE content LIKE \'%å…³é”®?\' AND deletedAt IS NULL;'
    }
  ];

  // CRUD æ“ä½œæ¨¡æ¿
  const crudTemplates = [
    {
      name: 'åˆ›å»ºæ–°æç¤ºè¯',
      query: `INSERT INTO prompts (id, title, content, category, tags, isFavorite, createdAt)
VALUES ('custom_id_${Date.now()}', 'æ–°æç¤ºè¯æ ‡é¢˜', 'æç¤ºè¯å†…?..', 'Code', '["æ ‡ç­¾1", "æ ‡ç­¾2"]', 0, ${Date.now()});`
    },
    {
      name: 'æ›´æ–°æç¤ºè¯',
      query: `UPDATE prompts
SET title = 'æ›´æ–°åçš„æ ‡é¢˜', updatedAt = ${Date.now()}
WHERE id = 'existing_id';`
    },
    {
      name: 'è½¯åˆ é™¤æç¤ºè¯',
      query: `UPDATE prompts SET deletedAt = ${Date.now()} WHERE id = 'prompt_id';`
    },
    {
      name: 'æ°¸ä¹…åˆ é™¤æç¤ºè¯',
      query: 'DELETE FROM prompts WHERE id = \'prompt_id\';'
    },
    {
      name: 'è®¾ç½®æç¤ºè¯ä¸ºæ”¶è—',
      query: 'UPDATE prompts SET isFavorite = 1 WHERE id = \'prompt_id\';'
    }
  ];

  // æ ¼å¼åŒ–æ‰§è¡Œæ—¶?
  const formatExecutionTime = (ms: number) => {
    if (ms < 1000) return `${ms}ms`;
    return `${(ms / 1000).toFixed(2)}s`;
  };

  // æ ¼å¼åŒ–æ—¶é—´æˆ³
  const formatTimestamp = (timestamp: number) => {
    return new Date(timestamp).toLocaleString();
  };

  // Early return for initialization
  if (!isInitialized) {
    return (
      <div className={`bg-gray-900/98 border border-white/10 rounded-3xl shadow-2xl overflow-hidden ${className}`}>
        <div className="flex items-center justify-center h-64">
          <div className="text-center">
            <Icons.Database size={48} className="text-gray-600 mx-auto mb-4" />
            <div className="text-gray-400">æ­£åœ¨åˆå§‹?DuckDB...</div>
            {syncState.error && (
              <div className="text-red-400 text-sm mt-2">{syncState.error}</div>
            )}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className={`bg-gray-900/98 border border-white/10 rounded-3xl shadow-2xl overflow-hidden ${className}`}>
      {/* Header */}
      <div className="relative bg-gradient-to-br from-brand-500/10 via-purple-500/5 to-blue-500/10 border-b border-white/10">
        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent animate-shimmer"></div>
        <div className="relative flex items-center justify-between p-6">
          <div className="flex items-center gap-4">
            <div className="w-10 h-10 bg-gradient-to-br from-brand-500/20 to-purple-500/20 rounded-xl flex items-center justify-center border border-brand-500/30">
              <Icons.Database size={20} className="text-brand-400" />
            </div>
            <div>
              <h1 className="text-xl font-bold text-white">DuckDB æ•°æ®æ§åˆ¶å°</h1>
              <p className="text-sm text-gray-400">æ•°æ®åˆ†æ â€¢ SQL å·¥ä½œå° â€¢ æ‰§è¡Œå†å²</p>
            </div>
          </div>
          {onClose && (
            <button
              onClick={onClose}
              className="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 transform hover:scale-105"
            >
              <Icons.Close size={20} />
            </button>
          )}
        </div>
      </div>

      {/* TAB Navigation */}
      <div className="bg-gray-900/60 border-b border-white/5">
        <div className="flex">
          {[
            { id: 'analysis' as TabType, label: 'ğŸ’¬ æ•°æ®åˆ†æ', icon: Icons.BarChart3 },
            { id: 'workbench' as TabType, label: 'ğŸ“ SQL å·¥ä½œå°', icon: Icons.Code },
            { id: 'history' as TabType, label: 'ğŸ“ å†å² & æ”¶è—', icon: Icons.History }
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 flex items-center justify-center gap-2 py-4 px-4 text-sm font-medium transition-all duration-200 ${
                activeTab === tab.id
                  ? 'text-white bg-brand-500/20 border-b-2 border-brand-500'
                  : 'text-gray-400 hover:text-white hover:bg-white/5'
              }`}
            >
              <tab.icon size={16} />
              {tab.label}
            </button>
          ))}
        </div>
      </div>

      {/* Content Area */}
      <div className="flex-1 min-h-0">
        {activeTab === 'workbench' && (
          <div className="h-full flex flex-col">
            {/* Toolbar */}
            <div className="flex items-center justify-between p-4 border-b border-white/5 bg-gray-900/40">
              <div className="flex items-center gap-3">
                <button
                  onClick={() => setShowTableStructure(!showTableStructure)}
                  className={`flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg transition-all ${
                    showTableStructure
                      ? 'bg-purple-500/20 text-purple-300 border border-purple-500/30'
                      : 'bg-gray-800/60 hover:bg-gray-700/60 text-gray-300 border border-white/10'
                  }`}
                >
                  <Icons.Table size={14} />
                  ğŸ“ è¡¨ç»“?
                </button>

                <div className="h-4 w-px bg-white/10"></div>

                <div className="flex items-center gap-2">
                  <span className="text-xs text-gray-500">è¾“å…¥æ¨¡å¼:</span>
                  <div className="flex items-center bg-gray-800/60 rounded-lg p-1">
                    <button
                      onClick={() => setInputMode('sql')}
                      className={`flex items-center gap-1 px-3 py-1 text-xs rounded transition-all ${
                        inputMode === 'sql'
                          ? 'bg-brand-500 text-white'
                          : 'text-gray-300 hover:text-white hover:bg-gray-700/60'
                      }`}
                    >
                      <Icons.Code size={12} />
                      SQL
                    </button>
                    <button
                      onClick={() => setInputMode('natural')}
                      className={`flex items-center gap-1 px-3 py-1 text-xs rounded transition-all ${
                        inputMode === 'natural'
                          ? 'bg-brand-500 text-white'
                          : 'text-gray-300 hover:text-white hover:bg-gray-700/60'
                      }`}
                    >
                      <Icons.MessageCircle size={12} />
                      è‡ªç„¶è¯­è¨€
                    </button>
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2">
                <button
                  onClick={executeQuery}
                  disabled={!query.trim() || isExecuting}
                  className="flex items-center gap-2 px-4 py-2 bg-brand-500 hover:bg-brand-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-white text-sm rounded-lg transition-all duration-200 transform hover:scale-105"
                >
                  {isExecuting ? (
                    <Icons.Loader size={14} className="animate-spin" />
                  ) : (
                    <Icons.Play size={14} />
                  )}
                  {isExecuting ? 'æ‰§è¡Œ?..' : 'â–¶ï¸ æ‰§è¡Œ'}
                </button>
              </div>
            </div>

            {/* Main Content Area */}
            <div className="flex-1 flex min-h-0">
              {/* Table Structure Sidebar */}
              {showTableStructure && (
                <div className="w-64 border-r border-white/5 bg-gray-900/40 p-4">
                  <h3 className="text-sm font-semibold text-gray-200 mb-3">ğŸ“ è¡¨ç»“?/h3>
                  <div className="space-y-3">
                    <div className="bg-gray-800/50 rounded-lg p-3">
                      <h4 className="text-xs font-medium text-gray-300 mb-2">ğŸ“‹ prompts</h4>
                      <div className="text-xs text-gray-400 space-y-1">
                        <div>â€¢ id (INTEGER, PK)</div>
                        <div>â€¢ title (TEXT)</div>
                        <div>â€¢ content (TEXT)</div>
                        <div>â€¢ tags (TEXT)</div>
                        <div>â€¢ category (TEXT)</div>
                        <div>â€¢ isFavorite (INTEGER)</div>
                        <div>â€¢ createdAt (INTEGER)</div>
                        <div>â€¢ updatedAt (INTEGER)</div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* SQL Editor and Results */}
              <div className="flex-1 flex flex-col min-h-0">
                {/* SQL Editor */}
                <div className="p-4 border-b border-white/5">
                  <div className="space-y-3">
                    <textarea
                      ref={textareaRef}
                      value={query}
                      onChange={(e) => setQuery(e.target.value)}
                      onKeyDown={handleKeyDown}
                      placeholder={
                        inputMode === 'natural'
                          ? "æè¿°ä½ æƒ³è¦æŸ¥è¯¢çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š\n- æ˜¾ç¤ºæ‰€æœ‰ä»£ç ç›¸å…³çš„æç¤ºè¯\n- æŸ¥æ‰¾åŒ…å«AIæ ‡ç­¾çš„æ”¶è—æç¤ºè¯\n- ç»Ÿè®¡å„åˆ†ç±»çš„æç¤ºè¯æ•°?
                          : "è¾“å…¥ DuckDB SQL æŸ¥è¯¢..."
                      }
                      className="w-full h-32 bg-gray-800 border border-white/10 rounded-lg p-3 text-gray-200 font-mono text-sm resize-none focus:outline-none focus:border-brand-500/50"
                      disabled={isExecuting || isConverting}
                    />

                    {/* Action Buttons */}
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <button
                          onClick={clearResult}
                          className="flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white text-sm rounded transition-colors"
                        >
                          <Icons.Trash size={14} />
                          ğŸ—‘ æ¸…ç©º
                        </button>

                        <button
                          onClick={() => {/* TODO: Add to favorites */}}
                          className="flex items-center gap-2 px-3 py-1.5 bg-yellow-700 hover:bg-yellow-600 text-yellow-300 hover:text-white text-sm rounded transition-colors"
                        >
                          <Icons.Star size={14} />
?æ”¶è—
                        </button>
                      </div>

                      <div className="text-xs text-gray-500">
                        Ctrl+Enter æ‰§è¡ŒæŸ¥è¯¢
                      </div>
                    </div>
                  </div>
                </div>

                {/* Results Area */}
                <div className="flex-1 overflow-hidden">
                  {error && (
                    <div className="p-4 bg-red-900/20 border-l-4 border-red-500">
                      <div className="flex items-center gap-2 mb-2">
                        <Icons.Error size={16} className="text-red-400" />
                        <span className="text-red-400 font-semibold">æ‰§è¡Œå¤±è´¥</span>
                      </div>
                      <div className="text-red-300 text-sm font-mono bg-red-900/10 p-3 rounded border border-red-500/20">
                        {error}
                      </div>
                      <div className="text-red-400/70 text-xs mt-2">
                        è¯·æ£€?SQL è¯­æ³•æˆ–å°è¯•å…¶ä»–æŸ¥?
                      </div>
                    </div>
                  )}

                  {result && (
                    <div className="h-full flex flex-col">
                      {/* Results Header */}
                      <div className="flex items-center justify-between p-3 bg-gray-800/50 border-b border-white/5">
                        <div className="flex items-center gap-4 text-sm">
                          <span className="text-green-400 flex items-center gap-1">
                            <Icons.Check size={14} />
                            æ‰§è¡ŒæˆåŠŸ
                          </span>
                          {result.columns.length > 0 ? (
                            <>
                              <span className="text-gray-400">
                                {result.rowCount} ?Ã— {result.columns.length} ?
                              </span>
                              <span className="text-gray-400">
                                æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                              </span>
                            </>
                          ) : (
                            <span className="text-blue-400">
                              æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                            </span>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          {result.columns.length > 0 && (
                            <button
                              onClick={() => navigator.clipboard.writeText(JSON.stringify(result.rows, null, 2))}
                              className="text-gray-400 hover:text-white text-sm flex items-center gap-1"
                            >
                              <Icons.Copy size={14} />
                              å¤åˆ¶ç»“æœ
                            </button>
                          )}
                          <button
                            onClick={() => navigator.clipboard.writeText(
                              result.columns.length > 0
                                ? JSON.stringify(result.rows, null, 2)
                                : `æ‰§è¡ŒæˆåŠŸ${result.rowCount > 0 ? `ï¼Œå½±?${result.rowCount} è¡Œ` : ''}`
                            )}
                            className="text-gray-400 hover:text-white text-sm flex items-center gap-1"
                          >
                            <Icons.Copy size={14} />
                            å¤åˆ¶æ‘˜è¦
                          </button>
                        </div>
                      </div>

                      {/* Results Table */}
                      <div className="flex-1 overflow-auto">
                        {result.columns.length === 0 ? (
                          <div className="p-8 text-center">
                            <div className="text-green-400 mb-2">
                              <Icons.Check size={24} className="mx-auto" />
                            </div>
                            <div className="text-gray-300 font-medium mb-1">
                              {result.rowCount === 0 ? 'æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› 0 æ¡è®°å½•' : `æ‰§è¡ŒæˆåŠŸ${result.rowCount > 0 ? `ï¼Œå½±å“ ${result.rowCount} è¡Œ` : ''}`}
                            </div>
                            <div className="text-gray-500 text-sm">
                              æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                            </div>
                          </div>
                        ) : (
                          <table className="w-full text-sm">
                            <thead className="bg-gray-800/30 sticky top-0">
                              <tr>
                                {result.columns.map((column, index) => (
                                  <th
                                    key={index}
                                    className="px-3 py-2 text-left text-gray-300 font-semibold border-r border-white/5 last:border-r-0 hover:bg-gray-700/30 transition-colors cursor-pointer group"
                                    title={`ç‚¹å‡»æ’åº: ${column}`}
                                  >
                                    <div className="flex items-center gap-1">
                                      {column}
                                      <Icons.ChevronDown size={12} className="text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                                    </div>
                                  </th>
                                ))}
                              </tr>
                            </thead>
                            <tbody>
                              {result.rows.map((row, rowIndex) => (
                                <tr key={rowIndex} className="border-b border-white/5 hover:bg-white/5">
                                  {row.map((cell: any, cellIndex: number) => {
                                    const cellText = cell === null || cell === undefined ? 'NULL' : String(cell);
                                    const isLongText = cellText.length > 50;

                                    return (
                                      <td
                                        key={cellIndex}
                                        className="px-3 py-2 text-gray-200 border-r border-white/5 last:border-r-0 max-w-xs"
                                      >
                                        {cell === null || cell === undefined ? (
                                          <span className="text-gray-500 italic">NULL</span>
                                        ) : typeof cell === 'boolean' ? (
                                          <span className={cell ? 'text-green-400' : 'text-red-400'}>
                                            {cell ? 'TRUE' : 'FALSE'}
                                          </span>
                                        ) : isLongText ? (
                                          <div className="truncate" title={cellText}>
                                            {cellText.substring(0, 50)}...
                                            <button
                                              className="ml-1 text-blue-400 hover:text-blue-300 text-xs"
                                              title="ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å†…å®¹"
                                            >
                                              [å±•å¼€]
                                            </button>
                                          </div>
                                        ) : (
                                          <span className={typeof cell === 'number' ? 'text-blue-300' : ''}>
                                            {cellText}
                                          </span>
                                        )}
                                      </td>
                                    );
                                  })}
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        )}
                      </div>
                    </div>
                  )}

                  {!result && !error && (
                    <div className="p-8 text-center text-gray-500 h-full flex items-center justify-center">
                      <div>
                        <Icons.Database size={48} className="text-gray-600 mx-auto mb-4" />
                        <div>è¾“å…¥ SQL æŸ¥è¯¢å¹¶ç‚¹å‡»æ‰§è¡Œï¼Œæˆ–é€‰æ‹©ä¸€ä¸ªæŸ¥è¯¢æ¨¡æ¿</div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'analysis' && (
          <div className="h-full flex flex-col p-6">
            <div className="text-center py-12">
              <Icons.BarChart3 size={48} className="text-gray-600 mx-auto mb-4" />
              <div className="text-gray-400">æ•°æ®åˆ†æåŠŸèƒ½å¼€å‘ä¸­...</div>
              <div className="text-sm text-gray-500 mt-2">å³å°†æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’ŒAIé©±åŠ¨çš„æ•°æ®åˆ†?/div>
            </div>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="h-full flex flex-col">
            {/* Sub-tabs */}
            <div className="flex border-b border-white/5">
              <button className="flex-1 py-3 px-4 text-sm font-medium text-white bg-brand-500/20 border-b-2 border-brand-500">
                ğŸ• å†å²è®°å½•
              </button>
              <button className="flex-1 py-3 px-4 text-sm font-medium text-gray-400 hover:text-white transition-colors">
?æˆ‘çš„æ”¶è—
              </button>
            </div>

            {/* History List */}
            <div className="flex-1 overflow-y-auto">
              <div className="divide-y divide-white/5">
                {history.length === 0 ? (
                  <div className="p-8 text-center text-gray-500">
                    <Icons.History size={48} className="text-gray-600 mx-auto mb-4" />
                    <div>æš‚æ— æ‰§è¡Œå†å²</div>
                  </div>
                ) : (
                  history.map((item, index) => (
                    <div key={item.id} className="p-4 hover:bg-white/5 transition-colors">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                          <span className={`px-2 py-1 rounded text-xs ${
                            item.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                          }`}>
                            {item.inputType === 'natural' ? 'è‡ªç„¶è¯­è¨€' : 'SQL'}
                          </span>
                          <span className="text-xs text-gray-500">
                            {formatTimestamp(item.timestamp)}
                          </span>
                        </div>
                        <div className="flex items-center gap-2">
                          {item.success ? (
                            <Icons.Check size={14} className="text-green-400" />
                          ) : (
                            <Icons.Error size={14} className="text-red-400" />
                          )}
                          <button className="text-gray-400 hover:text-white text-xs">â†—ï¸</button>
                          <button className="text-gray-400 hover:text-yellow-400 text-xs">?/button>
                        </div>
                      </div>
                      <div className="text-sm text-gray-300 mb-1">
                        {item.executedSQL.length > 100 ? `${item.executedSQL.substring(0, 100)}...` : item.executedSQL}
                      </div>
                      <div className="text-xs text-gray-500">
                        {item.resultCount !== undefined ? `${item.resultCount} è¡Œ` : 'æ‰§è¡Œå®Œæˆ'}
                        {item.executionTime && ` Â· ${formatExecutionTime(item.executionTime)}`}
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        )}
      </div>
        <div className="flex-1 p-4 border-b border-white/5">
          <div className="space-y-3">
            {/* æ“ä½œæŒ‰é’® */}
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                {/* è¾“å…¥æ¨¡å¼åˆ‡æ¢ */}
                <div className="flex items-center bg-gray-700 rounded-lg p-1">
                  <button
                    onClick={() => {
                      setInputMode('sql');
                      setNl2sqlResult(null);
                      setShowConversionPreview(false);
                    }}
                    className={`flex items-center gap-1 px-3 py-1.5 text-xs rounded transition-colors ${
                      inputMode === 'sql'
                        ? 'bg-brand-500 text-white'
                        : 'text-gray-300 hover:text-white hover:bg-gray-600'
                    }`}
                  >
                    <Icons.Code size={12} />
                    SQL
                  </button>
                  <button
                    onClick={() => {
                      setInputMode('natural');
                      setNl2sqlResult(null);
                      setShowConversionPreview(false);
                    }}
                    className={`flex items-center gap-1 px-3 py-1.5 text-xs rounded transition-colors ${
                      inputMode === 'natural'
                        ? 'bg-brand-500 text-white'
                        : 'text-gray-300 hover:text-white hover:bg-gray-600'
                    }`}
                  >
                    <Icons.Info size={12} />
                    è‡ªç„¶è¯­è¨€
                  </button>
                </div>

                {/* æ‰§è¡ŒæŒ‰é’® */}
                {inputMode === 'natural' ? (
                  <button
                    onClick={handleNL2SQLConversion}
                    disabled={!query.trim() || isConverting}
                    className="flex items-center gap-2 px-3 py-1.5 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-white text-sm rounded transition-colors"
                  >
                    {isConverting ? (
                      <Icons.Loader size={14} className="animate-spin" />
                    ) : (
                      <Icons.Magic size={14} />
                    )}
                    {isConverting ? 'è½¬æ¢?..' : 'è½¬æ¢ä¸ºSQL'}
                  </button>
                ) : (
                  <button
                    onClick={() => executeQuery()}
                    disabled={!query.trim() || isExecuting}
                    className="flex items-center gap-2 px-3 py-1.5 bg-brand-500 hover:bg-brand-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-white text-sm rounded transition-colors"
                  >
                    {isExecuting ? (
                      <Icons.Loader size={14} className="animate-spin" />
                    ) : (
                      <Icons.Run size={14} />
                    )}
                    {isExecuting ? 'æ‰§è¡Œ?..' : 'æ‰§è¡Œ'}
                  </button>
                )}

                <button
                  onClick={clearResult}
                  className="flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white text-sm rounded transition-colors"
                >
                  <Icons.Trash size={14} />
                  æ¸…ç©º
                </button>

                <button
                  onClick={() => setShowHistory(!showHistory)}
                  className="flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white text-sm rounded transition-colors"
                >
                  <Icons.History size={14} />
                  å†å² ({history.length})
                </button>
              </div>

              <div className="text-xs text-gray-500">
                {inputMode === 'natural' ? 'Ctrl+Enter è½¬æ¢ä¸ºSQL' : 'Ctrl+Enter æ‰§è¡ŒæŸ¥è¯¢'}
              </div>
            </div>

            {/* æŸ¥è¯¢è¾“å…¥?*/}
            <div className="relative">
              <textarea
                ref={textareaRef}
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder={
                  inputMode === 'natural'
                    ? "æè¿°ä½ æƒ³è¦æŸ¥è¯¢çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š\n- æ˜¾ç¤ºæ‰€æœ‰ä»£ç ç›¸å…³çš„æç¤ºè¯\n- æŸ¥æ‰¾åŒ…å«AIæ ‡ç­¾çš„æ”¶è—æç¤ºè¯\n- ç»Ÿè®¡å„åˆ†ç±»çš„æç¤ºè¯æ•°?
                    : "è¾“å…¥ DuckDB SQL æŸ¥è¯¢..."
                }
                className="w-full h-32 bg-gray-800 border border-white/10 rounded p-3 text-gray-200 font-mono text-sm resize-none focus:outline-none focus:border-brand-500/50"
                disabled={isExecuting || isConverting}
              />

              {/* æŸ¥è¯¢æ¨¡æ¿ */}
              <div className="absolute top-2 right-2 flex gap-1">
                <div className="relative group">
                  <button className="text-gray-500 hover:text-gray-300 text-xs px-2 py-1 bg-gray-700/50 rounded">
                    æŸ¥è¯¢
                  </button>
                  <div className="absolute right-0 top-full mt-1 w-64 bg-gray-800 border border-white/10 rounded shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
                    <div className="p-2">
                      <div className="text-xs text-gray-400 mb-2">æŸ¥è¯¢æ¨¡æ¿</div>
                      {queryTemplates.map((template, index) => (
                        <button
                          key={index}
                          onClick={() => setQuery(template.query)}
                          className="w-full text-left text-xs text-gray-300 hover:text-white hover:bg-gray-700/50 p-2 rounded transition-colors"
                        >
                          {template.name}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="relative group">
                  <button className="text-gray-500 hover:text-gray-300 text-xs px-2 py-1 bg-gray-700/50 rounded">
                    CRUD
                  </button>
                  <div className="absolute right-0 top-full mt-1 w-72 bg-gray-800 border border-white/10 rounded shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
                    <div className="p-2">
                      <div className="text-xs text-gray-400 mb-2">CRUD æ“ä½œæ¨¡æ¿</div>
                      {crudTemplates.map((template, index) => (
                        <button
                          key={index}
                          onClick={() => setQuery(template.query)}
                          className="w-full text-left text-xs text-gray-300 hover:text-white hover:bg-gray-700/50 p-2 rounded transition-colors"
                        >
                          {template.name}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* å¯¹è¯ä¸Šä¸‹?*/}
            {conversationContext && conversationContext.conversationHistory.length > 0 && (
              <div className="bg-blue-900/10 border border-blue-500/20 rounded-lg p-3 mt-3">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <Icons.Info size={14} className="text-blue-400" />
                    <span className="text-blue-300 text-sm font-medium">å¯¹è¯ä¸Šä¸‹?/span>
                  </div>
                  <button
                    onClick={() => setConversationContext(null)}
                    className="text-gray-400 hover:text-white text-xs"
                  >
                    æ¸…ç©ºä¸Šä¸‹?
                  </button>
                </div>
                <div className="space-y-1 max-h-20 overflow-y-auto">
                  {conversationContext.conversationHistory.slice(-4).map((item, index) => (
                    <div key={index} className="text-xs">
                      <span className={item.type === 'user' ? 'text-blue-300' : 'text-green-300'}>
                        {item.type === 'user' ? '? : 'ç³»ç»Ÿ'}:
                      </span>
                      <span className="text-gray-300 ml-1">{item.message}</span>
                    </div>
                  ))}
                </div>
                <div className="text-xs text-gray-500 mt-2">
                  åç»­æŸ¥è¯¢å°†åŸºäºæ­¤ä¸Šä¸‹æ–‡ç†è§£ä½ çš„æ„?
                </div>
              </div>
            )}

            {/* NL2SQL è½¬æ¢é¢„è§ˆ */}
            {showConversionPreview && nl2sqlResult && (
              <div className="bg-gray-800/50 border border-purple-500/30 rounded-lg p-4 mt-3">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <Icons.Magic size={16} className="text-purple-400" />
                    <span className="text-purple-300 font-medium">NL2SQL è½¬æ¢ç»“æœ</span>
                    {nl2sqlResult.confidence && (
                      <span className="text-xs text-gray-400">
                        ç½®ä¿¡? {Math.round(nl2sqlResult.confidence * 100)}%
                      </span>
                    )}
                  </div>
                  <button
                    onClick={() => setShowConversionPreview(false)}
                    className="text-gray-400 hover:text-white"
                  >
                    <Icons.Close size={14} />
                  </button>
                </div>

                <div className="space-y-3">
                  <div>
                    <div className="text-sm text-gray-400 mb-1">è‡ªç„¶è¯­è¨€æ„å›¾?/div>
                    <div className="text-gray-200 bg-gray-900/50 p-2 rounded text-sm">
                      {query}
                    </div>
                  </div>

                  <div>
                    <div className="text-sm text-gray-400 mb-1">ç”Ÿæˆçš„SQL?/div>
                    <div className="bg-gray-900 p-3 rounded font-mono text-sm text-green-300 border border-gray-600">
                      {nl2sqlResult.sql}
                    </div>
                  </div>

                  {nl2sqlResult.explanation && (
                    <div className="text-xs text-gray-500">
                      {nl2sqlResult.explanation}
                    </div>
                  )}

                  <div className="flex items-center gap-2 pt-2">
                    <button
                      onClick={confirmExecuteConvertedSQL}
                      disabled={isExecuting}
                      className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white text-sm rounded transition-colors"
                    >
                      {isExecuting ? (
                        <Icons.Loader size={14} className="animate-spin" />
                      ) : (
                        <Icons.Play size={14} />
                      )}
                      æ‰§è¡ŒSQL
                    </button>

                    <button
                      onClick={editConvertedSQL}
                      className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition-colors"
                    >
                      <Icons.Edit size={14} />
                      ç¼–è¾‘SQL
                    </button>

                    <button
                      onClick={() => setShowConversionPreview(false)}
                      className="flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-gray-300 hover:text-white text-sm rounded transition-colors"
                    >
                      <Icons.Close size={14} />
                      å–æ¶ˆ
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* æŸ¥è¯¢å†å² */}
            {showHistory && history.length > 0 && (
              <div
                ref={historyRef}
                className="bg-gray-800 border border-white/10 rounded max-h-40 overflow-y-auto"
              >
                <div className="flex items-center justify-between p-2 border-b border-white/10">
                  <span className="text-sm text-gray-300">æŸ¥è¯¢å†å²</span>
                  <button
                    onClick={clearHistory}
                    className="text-xs text-red-400 hover:text-red-300"
                  >
                    æ¸…ç©ºå†å²
                  </button>
                </div>
                {history.map((item, index) => (
                  <button
                    key={item.id}
                    onClick={() => loadFromHistory(item)}
                    className={`w-full text-left p-2 hover:bg-gray-700/50 transition-colors ${
                      selectedHistoryIndex === index ? 'bg-brand-500/20' : ''
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex-1 truncate">
                        <div className="text-sm text-gray-200 truncate">
                          <span className={item.inputType === 'natural' ? 'text-purple-300' : 'text-blue-300'}>
                            [{item.inputType === 'natural' ? 'è‡ªç„¶è¯­è¨€' : 'SQL'}]
                          </span> {item.inputText}
                          {item.generatedSQL && (
                            <span className="text-green-300 block text-xs mt-1">
?{item.generatedSQL}
                            </span>
                          )}
                        </div>
                        <div className="text-xs text-gray-500 flex items-center gap-2">
                          <span>{formatTimestamp(item.timestamp)}</span>
                          {item.executionTime && (
                            <span>{formatExecutionTime(item.executionTime)}</span>
                          )}
                          {item.resultCount !== undefined && (
                            <span>{item.resultCount} ?/span>
                          )}
                          {item.inputType === 'natural' && (
                            <span className="text-purple-400">NL2SQL</span>
                          )}
                        </div>
                      </div>
                      <div className="flex items-center gap-1 ml-2">
                        {item.success ? (
                          <Icons.Check size={12} className="text-green-400" />
                        ) : (
                          <Icons.Error size={12} className="text-red-400" />
                        )}
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* ç»“æœæ˜¾ç¤ºåŒºåŸŸ */}
        <div className="flex-1 overflow-hidden">
          {error && (
            <div className="p-4 bg-red-900/20 border-l-4 border-red-500">
              <div className="flex items-center gap-2 mb-2">
                <Icons.Error size={16} className="text-red-400" />
                <span className="text-red-400 font-semibold">æ‰§è¡Œå¤±è´¥</span>
              </div>
              <div className="text-red-300 text-sm font-mono bg-red-900/10 p-3 rounded border border-red-500/20">
                {error}
              </div>
              <div className="text-red-400/70 text-xs mt-2">
                è¯·æ£€?SQL è¯­æ³•æˆ–å°è¯•å…¶ä»–æŸ¥?
              </div>
            </div>
          )}

          {result && (
            <div className="h-full flex flex-col">
              {/* ç»“æœå¤´éƒ¨ä¿¡æ¯ */}
              <div className="flex items-center justify-between p-3 bg-gray-800/50 border-b border-white/5">
                <div className="flex items-center gap-4 text-sm">
                  <span className="text-green-400 flex items-center gap-1">
                    <Icons.Check size={14} />
                    æ‰§è¡ŒæˆåŠŸ
                  </span>
                  {result.columns.length > 0 ? (
                    <>
                  <span className="text-gray-400">
                    {result.rowCount} ?Ã— {result.columns.length} ?
                  </span>
                  {result.columns.length > 0 && result.rows.length > 0 && (
                    <span className="text-gray-400">
                      æ•°æ®å¤§å°: ~{Math.round(JSON.stringify(result.rows).length / 1024)}KB
                    </span>
                  )}
                  <span className="text-gray-400">
                    æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                  </span>
                    </>
                  ) : (
                    <span className="text-blue-400">
                      æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                    </span>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  {result.columns.length > 0 && (
                    <button
                      onClick={() => navigator.clipboard.writeText(JSON.stringify(result.rows, null, 2))}
                      className="text-gray-400 hover:text-white text-sm flex items-center gap-1"
                    >
                      <Icons.Copy size={14} />
                      å¤åˆ¶ç»“æœ
                    </button>
                  )}
                  <button
                    onClick={() => navigator.clipboard.writeText(
                      result.columns.length > 0
                        ? JSON.stringify(result.rows, null, 2)
                        : `æ‰§è¡ŒæˆåŠŸ${result.rowCount > 0 ? `ï¼Œå½±?${result.rowCount} è¡Œ` : ''}`
                    )}
                    className="text-gray-400 hover:text-white text-sm flex items-center gap-1"
                  >
                    <Icons.Copy size={14} />
                    å¤åˆ¶æ‘˜è¦
                  </button>
                </div>
              </div>

              {/* ç»“æœè¡¨æ ¼ */}
              <div className="flex-1 overflow-auto">
                {result.columns.length === 0 ? (
                  <div className="p-8 text-center">
                    <div className="text-green-400 mb-2">
                      <Icons.Check size={24} className="mx-auto" />
                    </div>
                    <div className="text-gray-300 font-medium mb-1">
                      {result.rowCount === 0 ? 'æŸ¥è¯¢æˆåŠŸï¼Œè¿”?0 æ¡è®°? : `æ‰§è¡ŒæˆåŠŸ${result.rowCount > 0 ? `ï¼Œå½±?${result.rowCount} è¡Œ` : ''}`}
                    </div>
                    <div className="text-gray-500 text-sm">
                      æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                    </div>
                  </div>
                ) : (
                  <table className="w-full text-sm">
                    <thead className="bg-gray-800/30 sticky top-0">
                      <tr>
                        {result.columns.map((column, index) => (
                          <th
                            key={index}
                            className="px-3 py-2 text-left text-gray-300 font-semibold border-r border-white/5 last:border-r-0 hover:bg-gray-700/30 transition-colors cursor-pointer group"
                            title={`ç‚¹å‡»æ’åº: ${column}`}
                          >
                            <div className="flex items-center gap-1">
                              {column}
                              <Icons.ChevronDown size={12} className="text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                            </div>
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {result.rows.map((row, rowIndex) => (
                        <tr key={rowIndex} className="border-b border-white/5 hover:bg-white/5">
                          {row.map((cell: any, cellIndex: number) => {
                            const cellText = cell === null || cell === undefined ? 'NULL' : String(cell);
                            const isLongText = cellText.length > 50;

                            return (
                              <td
                                key={cellIndex}
                                className="px-3 py-2 text-gray-200 border-r border-white/5 last:border-r-0 max-w-xs"
                              >
                                {cell === null || cell === undefined ? (
                                  <span className="text-gray-500 italic">NULL</span>
                                ) : typeof cell === 'boolean' ? (
                                  <span className={cell ? 'text-green-400' : 'text-red-400'}>
                                    {cell ? 'TRUE' : 'FALSE'}
                                  </span>
                                ) : isLongText ? (
                                  <div className="truncate" title={cellText}>
                                    {cellText.substring(0, 50)}...
                                    <button
                                      className="ml-1 text-blue-400 hover:text-blue-300 text-xs"
                                      title="ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å†…å®¹"
                                    >
                                      [å±•å¼€]
                                    </button>
                                  </div>
                                ) : (
                                  <span className={typeof cell === 'number' ? 'text-blue-300' : ''}>
                                    {cellText}
                                  </span>
                                )}
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                )}
              </div>
            </div>
          )}

          {!result && !error && (
            <div className="p-8 text-center text-gray-500 h-full flex items-center justify-center">
              <div>
                <Icons.Database size={48} className="text-gray-600 mx-auto mb-4" />
                <div>è¾“å…¥ SQL æŸ¥è¯¢å¹¶ç‚¹å‡»æ‰§è¡Œï¼Œæˆ–é€‰æ‹©ä¸€ä¸ªæŸ¥è¯¢æ¨¡?/div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );

  return (
    <div className={`bg-gray-900/98 border border-white/10 rounded-3xl shadow-2xl overflow-hidden ${className}`}>
      {/* Header */}
      <div className="relative bg-gradient-to-br from-brand-500/10 via-purple-500/5 to-blue-500/10 border-b border-white/10">
        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent animate-shimmer"></div>
        <div className="relative flex items-center justify-between p-6">
          <div className="flex items-center gap-4">
            <div className="w-10 h-10 bg-gradient-to-br from-brand-500/20 to-purple-500/20 rounded-xl flex items-center justify-center border border-brand-500/30">
              <Icons.Database size={20} className="text-brand-400" />
            </div>
            <div>
              <h1 className="text-xl font-bold text-white">DuckDB æ•°æ®æ§åˆ¶å°</h1>
              <p className="text-sm text-gray-400">æ•°æ®åˆ†æ â€¢ SQL å·¥ä½œå° â€¢ æ‰§è¡Œå†å²</p>
            </div>
          </div>
          {onClose && (
            <button
              onClick={onClose}
              className="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200 transform hover:scale-105"
            >
              <Icons.Close size={20} />
            </button>
          )}
        </div>
      </div>

      {/* TAB Navigation */}
      <div className="bg-gray-900/60 border-b border-white/5">
        <div className="flex">
          {[
            { id: 'analysis' as TabType, label: 'ğŸ’¬ æ•°æ®åˆ†æ', icon: Icons.BarChart3 },
            { id: 'workbench' as TabType, label: 'ğŸ“ SQL å·¥ä½œå°', icon: Icons.Code },
            { id: 'history' as TabType, label: 'ğŸ“ å†å² & æ”¶è—', icon: Icons.History }
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 flex items-center justify-center gap-2 py-4 px-4 text-sm font-medium transition-all duration-200 ${
                activeTab === tab.id
                  ? 'text-white bg-brand-500/20 border-b-2 border-brand-500'
                  : 'text-gray-400 hover:text-white hover:bg-white/5'
              }`}
            >
              <tab.icon size={16} />
              {tab.label}
            </button>
          ))}
        </div>
      </div>

      {/* Content Area */}
      <div className="flex-1 min-h-0">
        {activeTab === 'workbench' && (
          <div className="h-full flex flex-col">
            {/* Toolbar */}
            <div className="flex items-center justify-between p-4 border-b border-white/5 bg-gray-900/40">
              <div className="flex items-center gap-3">
                <button
                  onClick={() => setShowTableStructure(!showTableStructure)}
                  className={`flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg transition-all ${
                    showTableStructure
                      ? 'bg-purple-500/20 text-purple-300 border border-purple-500/30'
                      : 'bg-gray-800/60 hover:bg-gray-700/60 text-gray-300 border border-white/10'
                  }`}
                >
                  <Icons.Table size={14} />
                  ğŸ“ è¡¨ç»“æ„
                </button>

                <div className="h-4 w-px bg-white/10"></div>

                <div className="flex items-center gap-2">
                  <span className="text-xs text-gray-500">è¾“å…¥æ¨¡å¼:</span>
                  <div className="flex items-center bg-gray-800/60 rounded-lg p-1">
                    <button
                      onClick={() => setInputMode('sql')}
                      className={`flex items-center gap-1 px-3 py-1 text-xs rounded transition-all ${
                        inputMode === 'sql'
                          ? 'bg-brand-500 text-white'
                          : 'text-gray-300 hover:text-white hover:bg-gray-700/60'
                      }`}
                    >
                      <Icons.Code size={12} />
                      SQL
                    </button>
                    <button
                      onClick={() => setInputMode('natural')}
                      className={`flex items-center gap-1 px-3 py-1 text-xs rounded transition-all ${
                        inputMode === 'natural'
                          ? 'bg-brand-500 text-white'
                          : 'text-gray-300 hover:text-white hover:bg-gray-700/60'
                      }`}
                    >
                      <Icons.MessageCircle size={12} />
                      è‡ªç„¶è¯­è¨€
                    </button>
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2">
                <button
                  onClick={executeQuery}
                  disabled={!query.trim() || isExecuting}
                  className="flex items-center gap-2 px-4 py-2 bg-brand-500 hover:bg-brand-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-white text-sm rounded-lg transition-all duration-200 transform hover:scale-105"
                >
                  {isExecuting ? (
                    <Icons.Loader size={14} className="animate-spin" />
                  ) : (
                    <Icons.Play size={14} />
                  )}
                  {isExecuting ? 'æ‰§è¡Œä¸­...' : 'â–¶ï¸ æ‰§è¡Œ'}
                </button>
              </div>
            </div>

            {/* Main Content Area */}
            <div className="flex-1 flex min-h-0">
              {/* Table Structure Sidebar */}
              {showTableStructure && (
                <div className="w-64 border-r border-white/5 bg-gray-900/40 p-4">
                  <h3 className="text-sm font-semibold text-gray-200 mb-3">ğŸ“ è¡¨ç»“æ„</h3>
                  <div className="space-y-3">
                    <div className="bg-gray-800/50 rounded-lg p-3">
                      <h4 className="text-xs font-medium text-gray-300 mb-2">ğŸ“‹ prompts</h4>
                      <div className="text-xs text-gray-400 space-y-1">
                        <div>â€¢ id (INTEGER, PK)</div>
                        <div>â€¢ title (TEXT)</div>
                        <div>â€¢ content (TEXT)</div>
                        <div>â€¢ tags (TEXT)</div>
                        <div>â€¢ category (TEXT)</div>
                        <div>â€¢ isFavorite (INTEGER)</div>
                        <div>â€¢ createdAt (INTEGER)</div>
                        <div>â€¢ updatedAt (INTEGER)</div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* SQL Editor and Results */}
              <div className="flex-1 flex flex-col min-h-0">
                {/* SQL Editor */}
                <div className="p-4 border-b border-white/5">
                  <div className="space-y-3">
                    <textarea
                      ref={textareaRef}
                      value={query}
                      onChange={(e) => setQuery(e.target.value)}
                      onKeyDown={handleKeyDown}
                      placeholder={
                        inputMode === 'natural'
                          ? "æè¿°ä½ æƒ³è¦æŸ¥è¯¢çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š\n- æ˜¾ç¤ºæ‰€æœ‰ä»£ç ç›¸å…³çš„æç¤ºè¯\n- æŸ¥æ‰¾åŒ…å«AIæ ‡ç­¾çš„æ”¶è—æç¤ºè¯\n- ç»Ÿè®¡å„åˆ†ç±»çš„æç¤ºè¯æ•°é‡"
                          : "è¾“å…¥ DuckDB SQL æŸ¥è¯¢..."
                      }
                      className="w-full h-32 bg-gray-800 border border-white/10 rounded-lg p-3 text-gray-200 font-mono text-sm resize-none focus:outline-none focus:border-brand-500/50"
                      disabled={isExecuting || isConverting}
                    />

                    {/* Action Buttons */}
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <button
                          onClick={clearResult}
                          className="flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white text-sm rounded transition-colors"
                        >
                          <Icons.Trash size={14} />
                          ğŸ—‘ æ¸…ç©º
                        </button>

                        <button
                          onClick={() => {/* TODO: Add to favorites */}}
                          className="flex items-center gap-2 px-3 py-1.5 bg-yellow-700 hover:bg-yellow-600 text-yellow-300 hover:text-white text-sm rounded transition-colors"
                        >
                          <Icons.Star size={14} />
                          â­ æ”¶è—
                        </button>
                      </div>

                      <div className="text-xs text-gray-500">
                        Ctrl+Enter æ‰§è¡ŒæŸ¥è¯¢
                      </div>
                    </div>
                  </div>
                </div>

                {/* Results Area */}
                <div className="flex-1 overflow-hidden">
                  {error && (
                    <div className="p-4 bg-red-900/20 border-l-4 border-red-500">
                      <div className="flex items-center gap-2 mb-2">
                        <Icons.Error size={16} className="text-red-400" />
                        <span className="text-red-400 font-semibold">æ‰§è¡Œå¤±è´¥</span>
                      </div>
                      <div className="text-red-300 text-sm font-mono bg-red-900/10 p-3 rounded border border-red-500/20">
                        {error}
                      </div>
                      <div className="text-red-400/70 text-xs mt-2">
                        è¯·æ£€æŸ¥ SQL è¯­æ³•æˆ–å°è¯•å…¶ä»–æŸ¥è¯¢
                      </div>
                    </div>
                  )}

                  {result && (
                    <div className="h-full flex flex-col">
                      {/* Results Header */}
                      <div className="flex items-center justify-between p-3 bg-gray-800/50 border-b border-white/5">
                        <div className="flex items-center gap-4 text-sm">
                          <span className="text-green-400 flex items-center gap-1">
                            <Icons.Check size={14} />
                            æ‰§è¡ŒæˆåŠŸ
                          </span>
                          {result.columns.length > 0 ? (
                            <>
                              <span className="text-gray-400">
                                {result.rowCount} è¡Œ Ã— {result.columns.length} åˆ—
                              </span>
                              <span className="text-gray-400">
                                æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                              </span>
                            </>
                          ) : (
                            <span className="text-blue-400">
                              æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                            </span>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          {result.columns.length > 0 && (
                            <button
                              onClick={() => navigator.clipboard.writeText(JSON.stringify(result.rows, null, 2))}
                              className="text-gray-400 hover:text-white text-sm flex items-center gap-1"
                            >
                              <Icons.Copy size={14} />
                              å¤åˆ¶ç»“æœ
                            </button>
                          )}
                          <button
                            onClick={() => navigator.clipboard.writeText(
                              result.columns.length > 0
                                ? JSON.stringify(result.rows, null, 2)
                                : `æ‰§è¡ŒæˆåŠŸ${result.rowCount > 0 ? `ï¼Œå½±å“ ${result.rowCount} è¡Œ` : ''}`
                            )}
                            className="text-gray-400 hover:text-white text-sm flex items-center gap-1"
                          >
                            <Icons.Copy size={14} />
                            å¤åˆ¶æ‘˜è¦
                          </button>
                        </div>
                      </div>

                      {/* Results Table */}
                      <div className="flex-1 overflow-auto">
                        {result.columns.length === 0 ? (
                          <div className="p-8 text-center">
                            <div className="text-green-400 mb-2">
                              <Icons.Check size={24} className="mx-auto" />
                            </div>
                            <div className="text-gray-300 font-medium mb-1">
                              {result.rowCount === 0 ? 'æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› 0 æ¡è®°å½•' : `æ‰§è¡ŒæˆåŠŸ${result.rowCount > 0 ? `ï¼Œå½±å“ ${result.rowCount} è¡Œ` : ''}`}
                            </div>
                            <div className="text-gray-500 text-sm">
                              æ‰§è¡Œæ—¶é—´: {formatExecutionTime(result.executionTime)}
                            </div>
                          </div>
                        ) : (
                          <table className="w-full text-sm">
                            <thead className="bg-gray-800/30 sticky top-0">
                              <tr>
                                {result.columns.map((column, index) => (
                                  <th
                                    key={index}
                                    className="px-3 py-2 text-left text-gray-300 font-semibold border-r border-white/5 last:border-r-0 hover:bg-gray-700/30 transition-colors cursor-pointer group"
                                    title={`ç‚¹å‡»æ’åº: ${column}`}
                                  >
                                    <div className="flex items-center gap-1">
                                      {column}
                                      <Icons.ChevronDown size={12} className="text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                                    </div>
                                  </th>
                                ))}
                              </tr>
                            </thead>
                            <tbody>
                              {result.rows.map((row, rowIndex) => (
                                <tr key={rowIndex} className="border-b border-white/5 hover:bg-white/5">
                                  {row.map((cell: any, cellIndex: number) => {
                                    const cellText = cell === null || cell === undefined ? 'NULL' : String(cell);
                                    const isLongText = cellText.length > 50;

                                    return (
                                      <td
                                        key={cellIndex}
                                        className="px-3 py-2 text-gray-200 border-r border-white/5 last:border-r-0 max-w-xs"
                                      >
                                        {cell === null || cell === undefined ? (
                                          <span className="text-gray-500 italic">NULL</span>
                                        ) : typeof cell === 'boolean' ? (
                                          <span className={cell ? 'text-green-400' : 'text-red-400'}>
                                            {cell ? 'TRUE' : 'FALSE'}
                                          </span>
                                        ) : isLongText ? (
                                          <div className="truncate" title={cellText}>
                                            {cellText.substring(0, 50)}...
                                            <button
                                              className="ml-1 text-blue-400 hover:text-blue-300 text-xs"
                                              title="ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å†…å®¹"
                                            >
                                              [å±•å¼€]
                                            </button>
                                          </div>
                                        ) : (
                                          <span className={typeof cell === 'number' ? 'text-blue-300' : ''}>
                                            {cellText}
                                          </span>
                                        )}
                                      </td>
                                    );
                                  })}
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        )}
                      </div>
                    </div>
                  )}

                  {!result && !error && (
                    <div className="p-8 text-center text-gray-500 h-full flex items-center justify-center">
                      <div>
                        <Icons.Database size={48} className="text-gray-600 mx-auto mb-4" />
                        <div>è¾“å…¥ SQL æŸ¥è¯¢å¹¶ç‚¹å‡»æ‰§è¡Œï¼Œæˆ–é€‰æ‹©ä¸€ä¸ªæŸ¥è¯¢æ¨¡æ¿</div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'analysis' && (
          <div className="h-full flex flex-col p-6">
            <div className="text-center py-12">
              <Icons.BarChart3 size={48} className="text-gray-600 mx-auto mb-4" />
              <div className="text-gray-400">æ•°æ®åˆ†æåŠŸèƒ½å¼€å‘ä¸­...</div>
              <div className="text-sm text-gray-500 mt-2">å³å°†æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’ŒAIé©±åŠ¨çš„æ•°æ®åˆ†æ</div>
            </div>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="h-full flex flex-col">
            {/* Sub-tabs */}
            <div className="flex border-b border-white/5">
              <button className="flex-1 py-3 px-4 text-sm font-medium text-white bg-brand-500/20 border-b-2 border-brand-500">
                ğŸ• å†å²è®°å½•
              </button>
              <button className="flex-1 py-3 px-4 text-sm font-medium text-gray-400 hover:text-white transition-colors">
                â­ æˆ‘çš„æ”¶è—
              </button>
            </div>

            {/* History List */}
            <div className="flex-1 overflow-y-auto">
              <div className="divide-y divide-white/5">
                {history.length === 0 ? (
                  <div className="p-8 text-center text-gray-500">
                    <Icons.History size={48} className="text-gray-600 mx-auto mb-4" />
                    <div>æš‚æ— æ‰§è¡Œå†å²</div>
                  </div>
                ) : (
                  history.map((item, index) => (
                    <div key={item.id} className="p-4 hover:bg-white/5 transition-colors">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                          <span className={`px-2 py-1 rounded text-xs ${
                            item.success ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                          }`}>
                            {item.inputType === 'natural' ? 'è‡ªç„¶è¯­è¨€' : 'SQL'}
                          </span>
                          <span className="text-xs text-gray-500">
                            {formatTimestamp(item.timestamp)}
                          </span>
                        </div>
                        <div className="flex items-center gap-2">
                          {item.success ? (
                            <Icons.Check size={14} className="text-green-400" />
                          ) : (
                            <Icons.Error size={14} className="text-red-400" />
                          )}
                          <button className="text-gray-400 hover:text-white text-xs">â†—ï¸</button>
                          <button className="text-gray-400 hover:text-yellow-400 text-xs">â­</button>
                        </div>
                      </div>
                      <div className="text-sm text-gray-300 mb-1">
                        {item.executedSQL.length > 100 ? `${item.executedSQL.substring(0, 100)}...` : item.executedSQL}
                      </div>
                      <div className="text-xs text-gray-500">
                        {item.resultCount !== undefined ? `${item.resultCount} è¡Œ` : 'æ‰§è¡Œå®Œæˆ'}
                        {item.executionTime && ` Â· ${formatExecutionTime(item.executionTime)}`}
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
