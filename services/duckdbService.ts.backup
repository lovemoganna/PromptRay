import { Prompt } from '../types';
import { getPrompts } from './storageService';

// 简化的内存存储实现
// TODO: 替换为真正的 DuckDB 实现
let promptsStore = new Map<string, Prompt>();
let settingsStore = new Map<string, any>();
let isInitialized = false;

/**
 * 初始化存储服务
 */
export async function initializeDuckDB(): Promise<void> {
  if (isInitialized) return;

  // 从 localStorage 加载数据（作为持久化）
  loadFromLocalStorage();

  // 如果没有数据，从主存储服务同步数据
  if (promptsStore.size === 0) {
    try {
      console.info('Syncing data from main storage service...');
      const realPrompts = await getPrompts();
      realPrompts.forEach(prompt => {
        promptsStore.set(prompt.id, prompt);
      });
      // 保存到localStorage以便下次快速加载
      saveToLocalStorage();
      console.info(`Synced ${realPrompts.length} prompts from main storage`);
    } catch (error) {
      console.error('Failed to sync data from main storage:', error);
    }
  }

  isInitialized = true;
  console.info('DuckDB-like storage initialized');
}

/**
 * 从 localStorage 加载数据
 */
function loadFromLocalStorage(): void {
  try {
    const stored = localStorage.getItem('duckdb_prompts');
    if (stored) {
      const prompts = JSON.parse(stored);
      promptsStore = new Map(prompts.map((p: Prompt) => [p.id, p]));
    }
  } catch (error) {
    console.warn('Failed to load prompts from localStorage:', error);
  }

  try {
    const settings = localStorage.getItem('duckdb_settings');
    if (settings) {
      settingsStore = new Map(Object.entries(JSON.parse(settings)));
    }
  } catch (error) {
    console.warn('Failed to load settings from localStorage:', error);
  }
}

/**
 * 保存到 localStorage
 */
function saveToLocalStorage(): void {
  try {
    const prompts = Array.from(promptsStore.values());
    localStorage.setItem('duckdb_prompts', JSON.stringify(prompts));
  } catch (error) {
    console.warn('Failed to save prompts to localStorage:', error);
  }

  try {
    const settings = Object.fromEntries(settingsStore);
    localStorage.setItem('duckdb_settings', JSON.stringify(settings));
  } catch (error) {
    console.warn('Failed to save settings to localStorage:', error);
  }
}

/**
 * 获取所有提示词
 */
export async function getAllPrompts(): Promise<Prompt[]> {
  if (!isInitialized) await initializeDuckDB();
  return Array.from(promptsStore.values()).filter(p => !p.deletedAt);
}

/**
 * 根据 ID 获取单个提示词
 */
export async function getPromptById(id: string): Promise<Prompt | null> {
  if (!isInitialized) await initializeDuckDB();
  return promptsStore.get(id) || null;
}

/**
 * 插入新提示词
 */
export async function insertPrompt(prompt: Prompt): Promise<void> {
  if (!isInitialized) await initializeDuckDB();
  promptsStore.set(prompt.id, prompt);
  saveToLocalStorage();
}

/**
 * 更新提示词
 */
export async function updatePrompt(prompt: Prompt): Promise<void> {
  if (!isInitialized) await initializeDuckDB();
  promptsStore.set(prompt.id, { ...prompt, updatedAt: Date.now() });
  saveToLocalStorage();
}

/**
 * 删除提示词（软删除）
 */
export async function deletePrompt(id: string): Promise<void> {
  if (!isInitialized) await initializeDuckDB();
  const prompt = promptsStore.get(id);
  if (prompt) {
    promptsStore.set(id, { ...prompt, deletedAt: Date.now() });
    saveToLocalStorage();
  }
}

/**
 * 执行原生 SQL 查询（模拟实现）
 */
export async function executeSQL(sql: string, _params: any[] = []): Promise<any[]> {
  if (!isInitialized) await initializeDuckDB();

  // 简化的 SQL 解析和执行
  const sqlLower = sql.toLowerCase().trim();

  try {
    if (sqlLower.startsWith('select')) {
      // 处理 SELECT 查询
      if (sqlLower.includes('from prompts')) {
        let prompts = Array.from(promptsStore.values());

        // 解析WHERE条件
        let filteredPrompts = prompts;
        if (sqlLower.includes('where deletedat is null')) {
          filteredPrompts = prompts.filter(p => !p.deletedAt);
        }
        if (sqlLower.includes('where isfavorite = 1')) {
          filteredPrompts = filteredPrompts.filter(p => p.isFavorite);
        }
        if (sqlLower.includes('where category = \'code\'')) {
          filteredPrompts = filteredPrompts.filter(p => p.category?.toLowerCase() === 'code');
        }
        if (sqlLower.includes('where tags like \'%ai%\'')) {
          filteredPrompts = filteredPrompts.filter(p =>
            p.tags?.some(tag => tag.toLowerCase().includes('ai'))
          );
        }
        if (sqlLower.includes('where tags like \'%写作%\'')) {
          filteredPrompts = filteredPrompts.filter(p =>
            p.tags?.some(tag => tag.toLowerCase().includes('写作'))
          );
        }

        // 解析ORDER BY
        let sortedPrompts = filteredPrompts;
        if (sqlLower.includes('order by createdat desc')) {
          sortedPrompts = [...filteredPrompts].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        }
        if (sqlLower.includes('order by length(content) desc')) {
          sortedPrompts = [...filteredPrompts].sort((a, b) => (b.content?.length || 0) - (a.content?.length || 0));
        }

        // 解析LIMIT
        let limitedPrompts = sortedPrompts;
        const limitMatch = sqlLower.match(/limit (\d+)/);
        if (limitMatch) {
          const limit = parseInt(limitMatch[1]);
          limitedPrompts = sortedPrompts.slice(0, limit);
        }

        // 统计查询
        if (sqlLower.includes('count(*) as total')) {
          return [{ total: limitedPrompts.length }];
        }

        // 分类统计
        if (sqlLower.includes('category, count(*) as count') && sqlLower.includes('group by category')) {
          const categoryStats = limitedPrompts.reduce((acc, prompt) => {
            const category = prompt.category || '未分类';
            acc[category] = (acc[category] || 0) + 1;
            return acc;
          }, {} as Record<string, number>);

          return Object.entries(categoryStats)
            .map(([category, count]) => ({ category, count }))
            .sort((a, b) => b.count - a.count);
        }

        // 分类查询（返回所有分类）
        if (sqlLower.includes('distinct category')) {
          const categories = [...new Set(limitedPrompts.map(p => p.category).filter(Boolean))];
          return categories.map(category => ({ category }));
        }

        // 通用SELECT查询
        if (sqlLower.includes('select * from prompts')) {
          return limitedPrompts.map(p => ({
            id: p.id,
            title: p.title,
            content: p.content,
            category: p.category,
            tags: p.tags?.join(', ') || '',
            isFavorite: p.isFavorite ? 1 : 0,
            createdAt: p.createdAt,
            updatedAt: p.updatedAt
          }));
        }

        // 默认返回统计信息
        return [{ total_records: limitedPrompts.length, message: 'Query executed successfully' }];
      }

      // 处理其他表查询
      if (sqlLower.includes('from sql_history')) {
        // 这里应该从localStorage或其他存储中获取历史记录
        // 暂时返回模拟数据
        return [{ message: 'SQL history table query - data will be loaded from storage' }];
      }
      if (sqlLower.includes('from sql_favorites')) {
        // 这里应该从localStorage或其他存储中获取收藏记录
        return [{ message: 'SQL favorites table query - data will be loaded from storage' }];
      }
    }

    // 处理数据修改操作
    else if (sqlLower.startsWith('insert')) {
      if (sqlLower.includes('into prompts')) {
        const affectedRows = 1;
        return [{ affected_rows: affectedRows, message: 'Record inserted successfully' }];
      }
    }

    else if (sqlLower.startsWith('update')) {
      if (sqlLower.includes('prompts set')) {
        const affectedRows = 1;
        return [{ affected_rows: affectedRows, message: 'Record updated successfully' }];
      }
    }

    else if (sqlLower.startsWith('delete')) {
      if (sqlLower.includes('from prompts')) {
        const affectedRows = 1;
        return [{ affected_rows: affectedRows, message: 'Record deleted successfully' }];
      }
    }

    // CREATE TABLE 语句
    else if (sqlLower.startsWith('create table')) {
      return [{ message: 'Table created successfully (simulated)' }];
    }

    // 默认返回空结果并记录警告
    console.warn('Unsupported SQL query:', sql);
    console.info('Supported patterns: SELECT from prompts, INSERT/UPDATE/DELETE prompts');
    return [];
  } catch (error) {
    console.error('SQL execution error:', error);
    throw error;
  }
}

/**
 * 获取数据库统计信息
 */
export async function getDatabaseStats(): Promise<{
  totalPrompts: number;
  favoritePrompts: number;
  categories: number;
  totalTags: number;
}> {
  if (!isInitialized) await initializeDuckDB();

  const prompts = Array.from(promptsStore.values()).filter(p => !p.deletedAt);

  return {
    totalPrompts: prompts.length,
    favoritePrompts: prompts.filter(p => p.isFavorite).length,
    categories: new Set(prompts.map(p => p.category)).size,
    totalTags: prompts.reduce((sum, p) => sum + (p.tags?.length || 0), 0)
  };
}

/**
 * 关闭数据库连接
 */
export async function closeDatabase(): Promise<void> {
  saveToLocalStorage();
  isInitialized = false;
}
  if (!connection) throw new Error('DuckDB connection not initialized');

  const result = await connection.query(`
    SELECT * FROM prompts
    WHERE deleted_at IS NULL
    ORDER BY updated_at DESC, created_at DESC
  `);

  const prompts: Prompt[] = [];
  for (const row of result) {
    prompts.push(deserializePrompt(row.toJSON()));
  }

  return prompts;
}
export async function getPromptById(id: string): Promise<Prompt | null> {
  if (!isInitialized) await initializeDuckDB();
  if (!connection) throw new Error('DuckDB connection not initialized');

  const stmt = await connection.prepare(`
    SELECT * FROM prompts
    WHERE id = ? AND deleted_at IS NULL
  `);
  const result = await stmt.query(id);
  await stmt.close();

  if (result.numRows === 0) return null;

  return deserializePrompt(result.get(0)?.toJSON());
}

/**
 * 插入新提示词
 */
export async function insertPrompt(prompt: Prompt): Promise<void> {
  if (!isInitialized) await initializeDuckDB();
  if (!connection) throw new Error('DuckDB connection not initialized');

  const values = serializePrompt(prompt);
  const placeholders = values.map(() => '?').join(', ');

  const stmt = await connection!.prepare(`
    INSERT INTO prompts (
      id, title, content, english_prompt, chinese_prompt, system_instruction,
      examples, description, category, tags, output_type, application_scene,
      technical_tags, style_tags, custom_labels, preview_media_url, source,
      source_author, source_url, recommended_models, language, visibility,
      usage_notes, cautions, extracted, collected_at, is_favorite, status,
      config, history, saved_runs, last_variable_values, created_at, updated_at
    ) VALUES (${placeholders})
  `);
  await stmt.query(...values);
  await stmt.close();

  console.info(`Inserted prompt: ${prompt.title}`);
}

/**
 * 更新提示词
 */
export async function updatePrompt(prompt: Prompt): Promise<void> {
  if (!isInitialized) await initializeDuckDB();
  if (!connection) throw new Error('DuckDB connection not initialized');

  const updatedPrompt = { ...prompt, updatedAt: Date.now() };
  const values = serializePrompt(updatedPrompt);
  values.push(updatedPrompt.id); // 添加 WHERE id 的值

  const stmt = await connection!.prepare(`
    UPDATE prompts SET
      title = ?, content = ?, english_prompt = ?, chinese_prompt = ?, system_instruction = ?,
      examples = ?, description = ?, category = ?, tags = ?, output_type = ?, application_scene = ?,
      technical_tags = ?, style_tags = ?, custom_labels = ?, preview_media_url = ?, source = ?,
      source_author = ?, source_url = ?, recommended_models = ?, language = ?, visibility = ?,
      usage_notes = ?, cautions = ?, extracted = ?, collected_at = ?, is_favorite = ?, status = ?,
      config = ?, history = ?, saved_runs = ?, last_variable_values = ?, updated_at = ?
    WHERE id = ?
  `);
  await stmt.query(...values);
  await stmt.close();

  console.info(`Updated prompt: ${prompt.title}`);
}

/**
 * 删除提示词（软删除）
 */
export async function deletePrompt(id: string): Promise<void> {
  if (!isInitialized) await initializeDuckDB();
  if (!connection) throw new Error('DuckDB connection not initialized');

  const stmt = await connection!.prepare(`
    UPDATE prompts SET
      deleted_at = ?
    WHERE id = ? AND deleted_at IS NULL
  `);
  await stmt.query(Date.now(), id);
  await stmt.close();

  console.info(`Soft deleted prompt: ${id}`);
}

/**
 * 获取数据库统计信息
 */
export async function getDatabaseStats(): Promise<{
  totalPrompts: number;
  favoritePrompts: number;
  categories: number;
  totalTags: number;
}> {
  if (!isInitialized) await initializeDuckDB();
  if (!connection) throw new Error('DuckDB connection not initialized');

  const result = await connection!.query(`
    SELECT
      COUNT(*) as total_prompts,
      SUM(CASE WHEN is_favorite THEN 1 ELSE 0 END) as favorite_prompts,
      COUNT(DISTINCT category) as categories
    FROM prompts
    WHERE deleted_at IS NULL
  `);

  const stats = result.get(0)?.toJSON();
  return {
    totalPrompts: Number(stats?.total_prompts || 0),
    favoritePrompts: Number(stats?.favorite_prompts || 0),
    categories: Number(stats?.categories || 0),
    totalTags: 0 // 暂时设为0，稍后实现标签统计
  };
}

/**
 * 执行原生 DuckDB SQL 查询
 */
export async function executeSQL(sql: string, params: any[] = []): Promise<any[]> {
  if (!isInitialized) await initializeDuckDB();
  if (!connection) throw new Error('DuckDB connection not initialized');

  try {
    console.info('Executing SQL:', sql);

    // 对于 SELECT 查询，使用prepared statement
    if (sql.trim().toLowerCase().startsWith('select')) {
      if (params.length > 0) {
        const stmt = await connection!.prepare(sql);
        const result = await stmt.query(...params);
        await stmt.close();

        const rows: any[] = [];
        for (let i = 0; i < result.numRows; i++) {
          rows.push(result.get(i)?.toJSON());
        }

        console.info(`Query returned ${rows.length} rows`);
        return rows;
      } else {
        const result = await connection!.query(sql);
        const rows: any[] = [];
        for (let i = 0; i < result.numRows; i++) {
          rows.push(result.get(i)?.toJSON());
        }

        console.info(`Query returned ${rows.length} rows`);
        return rows;
      }
    }

    // 对于修改查询（INSERT, UPDATE, DELETE, CREATE等）
    else {
      if (params.length > 0) {
        const stmt = await connection!.prepare(sql);
        await stmt.query(...params);
        await stmt.close();
      } else {
        await connection!.query(sql);
      }
      console.info('Query executed successfully');

      return [{
        affected_rows: 1, // DuckDB WASM 不直接返回受影响行数，这里简化处理
        message: getSuccessMessage(sql)
      }];
    }

  } catch (error) {
    console.error('SQL execution error:', error);
    throw error;
  }
}

/**
 * 关闭数据库连接
 */
export async function closeDatabase(): Promise<void> {
  if (connection) {
    await connection.close();
    connection = null;
  }
  if (db) {
    await db.terminate();
    db = null;
  }
  isInitialized = false;
  console.info('DuckDB database closed');
}

// ============================================================================
// 辅助函数
// ============================================================================

/**
 * 序列化 Prompt 对象为数据库字段数组
 */
function serializePrompt(prompt: Prompt): any[] {
  return [
    prompt.id,
    prompt.title,
    prompt.content,
    prompt.englishPrompt || null,
    prompt.chinesePrompt || null,
    prompt.systemInstruction || null,
    prompt.examples ? JSON.stringify(prompt.examples) : null,
    prompt.description,
    prompt.category,
    prompt.tags ? JSON.stringify(prompt.tags) : null,
    prompt.outputType || null,
    prompt.applicationScene || null,
    prompt.technicalTags ? JSON.stringify(prompt.technicalTags) : null,
    prompt.styleTags ? JSON.stringify(prompt.styleTags) : null,
    prompt.customLabels ? JSON.stringify(prompt.customLabels) : null,
    prompt.previewMediaUrl || null,
    prompt.source || null,
    prompt.sourceAuthor || null,
    prompt.sourceUrl || null,
    prompt.recommendedModels ? JSON.stringify(prompt.recommendedModels) : null,
    prompt.language || null,
    prompt.visibility || null,
    prompt.usageNotes || null,
    prompt.cautions || null,
    prompt.extracted ? JSON.stringify(prompt.extracted) : null,
    prompt.collectedAt || null,
    prompt.isFavorite,
    prompt.status || 'active',
    prompt.config ? JSON.stringify(prompt.config) : null,
    prompt.history ? JSON.stringify(prompt.history) : null,
    prompt.savedRuns ? JSON.stringify(prompt.savedRuns) : null,
    prompt.lastVariableValues ? JSON.stringify(prompt.lastVariableValues) : null,
    prompt.createdAt,
    prompt.updatedAt || null
  ];
}

/**
 * 从数据库行反序列化为 Prompt 对象
 */
function deserializePrompt(row: any): Prompt {
  return {
    id: row.id,
    title: row.title,
    content: row.content,
    englishPrompt: row.english_prompt || undefined,
    chinesePrompt: row.chinese_prompt || undefined,
    systemInstruction: row.system_instruction || undefined,
    examples: row.examples ? JSON.parse(row.examples) : undefined,
    description: row.description,
    category: row.category,
    tags: row.tags ? JSON.parse(row.tags) : [],
    outputType: row.output_type || undefined,
    applicationScene: row.application_scene || undefined,
    technicalTags: row.technical_tags ? JSON.parse(row.technical_tags) : undefined,
    styleTags: row.style_tags ? JSON.parse(row.style_tags) : undefined,
    customLabels: row.custom_labels ? JSON.parse(row.custom_labels) : undefined,
    previewMediaUrl: row.preview_media_url || undefined,
    source: row.source || undefined,
    sourceAuthor: row.source_author || undefined,
    sourceUrl: row.source_url || undefined,
    recommendedModels: row.recommended_models ? JSON.parse(row.recommended_models) : undefined,
    language: row.language || undefined,
    visibility: row.visibility as 'public' | 'private' || undefined,
    usageNotes: row.usage_notes || undefined,
    cautions: row.cautions || undefined,
    extracted: row.extracted ? JSON.parse(row.extracted) : undefined,
    collectedAt: row.collected_at || undefined,
    isFavorite: Boolean(row.is_favorite),
    status: row.status as PromptStatus || 'active',
    config: row.config ? JSON.parse(row.config) : undefined,
    history: row.history ? JSON.parse(row.history) : undefined,
    savedRuns: row.saved_runs ? JSON.parse(row.saved_runs) : undefined,
    lastVariableValues: row.last_variable_values ? JSON.parse(row.last_variable_values) : undefined,
    createdAt: row.created_at,
    updatedAt: row.updated_at || undefined,
    deletedAt: row.deleted_at || undefined
  };
}

/**
 * 根据 SQL 类型返回成功消息
 */
function getSuccessMessage(sql: string): string {
  const sqlLower = sql.toLowerCase().trim();

  if (sqlLower.startsWith('insert')) {
    return 'Record inserted successfully';
  } else if (sqlLower.startsWith('update')) {
    return 'Record updated successfully';
  } else if (sqlLower.startsWith('delete')) {
    return 'Record deleted successfully';
  } else if (sqlLower.startsWith('create')) {
    return 'Table created successfully';
  } else if (sqlLower.startsWith('alter')) {
    return 'Table altered successfully';
  } else if (sqlLower.startsWith('drop')) {
    return 'Table dropped successfully';
  }

  return 'Query executed successfully';
}